<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RunIQ ‚Äî Race ¬∑ Plan ¬∑ Coach</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="runiq-kb.js"></script>
<style>
:root {
  --bg:#f8faff; --s1:#ffffff; --s2:#eef2ff; --s3:#e4ecff;
  --border:#dce3f5; --border2:#c8d4f0;
  --accent:#2563eb; --accent2:#f97316; --blue:#2563eb; --green:#10b981; --orange:#f97316;
  --text:#0d1b3e; --muted:#6b7fa8; --muted2:#9aaac8;
  --ai-color:#2563eb; --coach-color:#f97316; --r:6px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-weight:400;min-height:100vh;overflow-x:hidden;}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#login-screen{position:fixed;inset:0;z-index:500;background:var(--bg);display:flex;align-items:center;justify-content:center;}
.login-box{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:48px 56px;box-shadow:0 20px 60px rgba(37,99,235,.08);width:760px;max-width:95vw;animation:fadeUp .5s ease;}
.login-header{text-align:center;margin-bottom:40px;}
.login-panels{display:grid;grid-template-columns:1fr 1px 1fr;gap:0;align-items:start;}
.login-panel{padding:0 32px;}
.login-divider-v{background:var(--border);width:1px;height:100%;}
.login-logo{font-family:'Rajdhani',sans-serif;font-size:40px;font-weight:700;letter-spacing:4px;color:var(--text);margin-bottom:4px;}
.login-sub{font-family:IBM Plex Mono,monospace;font-size:10px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:4px;}
.login-panel-title{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.btn-coach{width:100%;background:var(--s2);color:var(--accent);border:1px solid var(--accent);border-radius:var(--r);padding:13px;font-family:IBM Plex Mono,monospace;font-size:11px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-coach:hover{background:rgba(232,255,71,.1);}
.coach-pw-input{width:100%;background:var(--s2);color:var(--text);border:1px solid var(--border);border-radius:var(--r);padding:11px 13px;font-family:IBM Plex Mono,monospace;font-size:11px;letter-spacing:2px;margin-bottom:10px;outline:none;box-sizing:border-box;}
.coach-pw-input:focus{border-color:var(--accent);}
.login-label{font-family:IBM Plex Mono,monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block;}
.login-input{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:12px 16px;color:var(--text);font-family:IBM Plex Mono,monospace;font-size:13px;outline:none;transition:border-color .2s;margin-bottom:12px;}
.login-input:focus{border-color:var(--accent);}
.btn-strava{width:100%;background:#fc4c02;color:#fff;border:none;border-radius:var(--r);padding:13px;font-family:IBM Plex Mono,monospace;font-size:11px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-strava:hover{background:#e04400;}
.login-divider{text-align:center;font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);margin:12px 0;letter-spacing:2px;}
.btn-demo{width:100%;background:transparent;color:var(--muted);border:1px solid var(--border);border-radius:var(--r);padding:11px;font-family:IBM Plex Mono,monospace;font-size:10px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-transform:uppercase;}
.btn-demo:hover{color:var(--text);border-color:var(--border2);}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--text);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;padding:0 28px;height:52px;gap:0;}
.nav-logo{font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;letter-spacing:3px;color:var(--text);margin-right:32px;text-decoration:none;}
.nav-logo span{color:var(--accent2);font-weight:700;}
.nav-tabs{display:flex;gap:0;flex:1;}
.nav-tab{display:flex;align-items:center;gap:7px;padding:0 18px;height:52px;font-family:IBM Plex Mono,monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.45);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;user-select:none;border-right:1px solid rgba(255,255,255,.1);}
.nav-tab:first-child{border-left:1px solid rgba(255,255,255,.1);}
.nav-tab:hover{color:rgba(255,255,255,.8);background:rgba(255,255,255,.06);}
.nav-tab.active{color:white;border-bottom-color:var(--accent2);background:rgba(255,255,255,.06);}
.tab-num{font-size:8px;color:rgba(255,255,255,.3);}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.athlete-chip{display:flex;align-items:center;gap:7px;padding:5px 12px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:20px;font-size:12px;color:rgba(255,255,255,.8);font-family:IBM Plex Mono,monospace;}
.athlete-chip img{width:20px;height:20px;border-radius:50%;object-fit:cover;}
.athlete-chip .dot{width:6px;height:6px;border-radius:50%;background:var(--green);}
.nav-coach-link{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:1px;color:var(--muted);padding:5px 10px;border:1px solid var(--border);border-radius:var(--r);text-decoration:none;transition:all .2s;}
.nav-coach-link:hover{color:var(--orange);border-color:rgba(255,159,67,.3);}
.settings-wrap{position:relative;}
.settings-dropdown{display:none;position:absolute;top:calc(100% + 8px);right:0;width:260px;background:var(--s1);border:1px solid var(--border2);border-radius:8px;padding:14px;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.15);}
.settings-dropdown.open{display:block;}
.settings-section-label{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;}
.settings-input{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:7px 10px;color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:12px;outline:none;margin-bottom:6px;transition:border-color .2s;}
.settings-input:focus{border-color:var(--accent);}
.settings-divider{height:1px;background:var(--border);margin:10px 0;}
.settings-persona-opt{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:4px;cursor:pointer;font-size:12px;transition:background .15s;}
.settings-persona-opt:hover{background:var(--s2);}
.settings-persona-opt.active{background:rgba(37,99,235,.08);color:var(--accent);}
.settings-btn-strava{width:100%;background:transparent;border:1px solid var(--border);border-radius:4px;padding:7px;font-family:IBM Plex Mono,monospace;font-size:10px;color:var(--muted);cursor:pointer;transition:all .2s;margin-top:4px;}
.settings-btn-strava:hover{border-color:var(--accent2);color:var(--accent2);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;top:64px;right:18px;z-index:450;background:var(--s1);border:1px solid var(--border2);border-left:3px solid var(--accent2);border-radius:8px;padding:10px 14px;font-family:IBM Plex Mono,monospace;font-size:10px;letter-spacing:1px;color:var(--text);box-shadow:0 12px 32px rgba(0,0,0,.12);opacity:0;transform:translateY(-8px);pointer-events:none;transition:opacity .2s ease,transform .2s ease;}
.toast.show{opacity:1;transform:translateY(0);}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none;padding-top:52px;min-height:100vh;}
.page.active{display:block;}

/* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
.page-header{padding:40px 40px 28px;border-bottom:1px solid var(--border);display:flex;align-items:flex-end;justify-content:space-between;gap:20px;}
.page-eyebrow{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:6px;}
.page-title{font-family:'Rajdhani',sans-serif;font-size:52px;font-weight:700;letter-spacing:1px;line-height:1;text-transform:uppercase;}
.page-title em{color:var(--accent);font-style:normal;}
.page-subtitle{font-size:13px;color:var(--muted);margin-top:6px;max-width:420px;line-height:1.6;}
.content{padding:28px 40px;}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:14px;}
.card-title{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.card-title::after{content:'';flex:1;height:1px;background:var(--border);}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
label.field-label{display:block;font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
select,input[type=text],input[type=number],textarea{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:9px 12px;color:var(--text);font-family:IBM Plex Mono,monospace;font-size:12px;outline:none;transition:border-color .2s;appearance:none;}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='none'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:32px;cursor:pointer;}
select:focus,input:focus,textarea:focus{border-color:var(--accent);}
.field{margin-bottom:14px;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:7px;padding:10px 20px;font-family:IBM Plex Mono,monospace;font-size:10px;font-weight:500;letter-spacing:1px;text-transform:uppercase;border:none;border-radius:var(--r);cursor:pointer;transition:all .2s;}
.btn-primary{background:var(--accent);color:#000;}
.btn-primary:hover{background:#f0ff6a;transform:translateY(-1px);}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--s2);color:var(--text);}
.btn-orange{background:rgba(255,159,67,.12);color:var(--orange);border:1px solid rgba(255,159,67,.25);}
.btn-orange:hover{background:rgba(255,159,67,.2);}

/* ‚îÄ‚îÄ GRIDS ‚îÄ‚îÄ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.stat-block{background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:14px 18px;}
.stat-label{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:7px;}
.stat-value{font-family:'Rajdhani',sans-serif;font-size:32px;font-weight:600;line-height:1;}
.stat-sub{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);margin-top:3px;}

/* ‚ïê‚ïê PAGE 1: ESTIMATOR ‚ïê‚ïê */
.estimator-grid{display:grid;grid-template-columns:300px 1fr;gap:20px;align-items:start;}
.race-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;}
.race-card{background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:18px 14px;text-align:center;position:relative;overflow:hidden;transition:border-color .3s;}
.race-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);transform:scaleX(0);transition:transform .4s;}
.race-card.live::before{transform:scaleX(1);}
.race-dist{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.race-time-big{font-family:'Rajdhani',sans-serif;font-size:36px;font-weight:700;line-height:1;}
.race-time-big.taper{color:var(--accent);}
.race-pace-sub{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);margin-top:3px;}
.race-delta{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--accent);margin-top:3px;height:12px;}
.taper-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);margin-top:10px;}
.toggle{position:relative;width:40px;height:22px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-track{position:absolute;inset:0;background:var(--s3);border:1px solid var(--border2);border-radius:22px;cursor:pointer;transition:all .3s;}
.toggle-track::before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:var(--muted);border-radius:50%;transition:all .3s;}
.toggle input:checked+.toggle-track{background:var(--accent);border-color:var(--accent);}
.toggle input:checked+.toggle-track::before{transform:translateX(18px);background:#000;}
.taper-detail{display:none;padding:10px 16px;background:rgba(255,159,67,.05);border:1px solid rgba(255,159,67,.2);border-radius:var(--r);margin-top:6px;}
.taper-detail.open{display:block;}

/* ‚ïê‚ïê PAGE 2: PLAN ‚ïê‚ïê */
.plan-builder{display:grid;grid-template-columns:340px 1fr;gap:20px;align-items:start;}
.philosophy-card{background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:8px;cursor:pointer;transition:all .2s;display:flex;gap:12px;align-items:flex-start;}
.philosophy-card:hover{border-color:var(--border2);background:var(--s3);}
.philosophy-card.selected{border-color:var(--accent);background:rgba(232,255,71,.04);}
.phil-icon{font-size:22px;flex-shrink:0;margin-top:1px;}
.phil-name{font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:600;margin-bottom:2px;}
.phil-tagline{font-size:11px;color:var(--muted);line-height:1.5;}
.phil-badge{margin-left:auto;font-family:IBM Plex Mono,monospace;font-size:8px;padding:2px 7px;border-radius:8px;border:1px solid var(--border);color:var(--muted);flex-shrink:0;}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:7px;margin-top:14px;}
.day-block{background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:10px 8px;min-height:90px;display:flex;flex-direction:column;gap:5px;}
.day-name{font-family:IBM Plex Mono,monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.day-workout{font-size:11px;font-weight:500;line-height:1.4;flex:1;}
.day-dist{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--accent);margin-top:auto;}
.day-type{font-family:IBM Plex Mono,monospace;font-size:7px;padding:2px 5px;border-radius:2px;display:inline-block;width:fit-content;}
.day-type.easy{background:rgba(102,102,102,.2);color:var(--muted);}
.day-type.tempo{background:rgba(61,158,255,.15);color:var(--blue);}
.day-type.long{background:rgba(232,255,71,.1);color:var(--accent);}
.day-type.vo2{background:rgba(255,77,46,.15);color:var(--accent2);}
.day-type.rest{background:transparent;color:var(--muted2);border:1px solid var(--border);}
.baseline-banner{padding:10px 14px;background:rgba(61,158,255,.06);border:1px solid rgba(61,158,255,.2);border-radius:var(--r);font-size:12px;color:var(--blue);margin-bottom:12px;line-height:1.5;}

/* ‚ïê‚ïê PAGE 3: COACH ‚ïê‚ïê */
.coach-layout{display:grid;grid-template-columns:260px 1fr 280px;height:calc(100vh - 52px);}
.coach-sidebar{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.coach-sidebar-header{padding:16px;border-bottom:1px solid var(--border);}
.sidebar-label{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}

/* Persona select */
.persona-badge{display:flex;align-items:center;gap:9px;padding:9px 12px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;transition:border-color .2s;}
.persona-badge:hover{border-color:var(--border2);}
.persona-wrap{position:relative;}
.persona-dropdown{display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--s2);border:1px solid var(--border2);border-radius:var(--r);z-index:50;overflow:hidden;}
.persona-dropdown.open{display:block;}
.persona-opt{display:flex;align-items:center;gap:9px;padding:9px 12px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border);}
.persona-opt:last-child{border-bottom:none;}
.persona-opt:hover{background:var(--s3);}
.persona-opt.active{background:rgba(232,255,71,.05);}

/* Workout history */
.workout-history{flex:1;overflow-y:auto;padding:10px;}
/* ‚îÄ‚îÄ RX WEEKLY PANEL ‚îÄ‚îÄ */
.rx-week-toggle{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;background:rgba(37,99,235,.04);transition:background .15s;}
.rx-week-toggle:hover{background:rgba(37,99,235,.08);}
.rx-day-row{padding:9px 14px;border-bottom:1px solid var(--border);cursor:default;transition:background .15s;}
.rx-day-row.today{border-left:3px solid var(--accent);}
.rx-day-row.completed{background:rgba(16,185,129,.02);}
.rx-day-row.missed{background:rgba(239,68,68,.02);}
.rx-row-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;}
.rx-row-day{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.rx-row-status{font-family:IBM Plex Mono,monospace;font-size:9px;padding:1px 6px;border-radius:8px;}
.rx-row-status.upcoming{color:var(--muted);border:1px solid var(--border);}
.rx-row-status.completed{color:var(--green);border:1px solid rgba(16,185,129,.3);background:rgba(16,185,129,.05);}
.rx-row-status.missed{color:var(--accent2);border:1px solid rgba(249,115,22,.3);background:rgba(249,115,22,.05);}
.rx-row-label{font-size:12px;font-weight:500;margin-bottom:2px;}
.rx-row-detail{font-size:11px;color:var(--muted);}
.rx-btn{font-family:IBM Plex Mono,monospace;font-size:9px;padding:3px 8px;border-radius:4px;border:none;cursor:pointer;margin-top:5px;margin-right:4px;transition:all .15s;}
.rx-btn.analyze{background:rgba(37,99,235,.1);color:var(--accent);border:1px solid rgba(37,99,235,.3);}
.rx-btn.discuss{background:rgba(249,115,22,.08);color:var(--accent2);border:1px solid rgba(249,115,22,.3);}
.rx-grade{font-family:IBM Plex Mono,monospace;font-size:11px;font-weight:600;padding:2px 7px;border-radius:10px;}
.rx-grade.A{color:#10b981;background:rgba(16,185,129,.1);}
.rx-grade.B{color:var(--accent);background:rgba(37,99,235,.1);}
.rx-grade.C{color:var(--accent2);background:rgba(249,115,22,.08);}
.rx-grade.D,.rx-grade.F{color:#ef4444;background:rgba(239,68,68,.08);}
.history-item{padding:10px;border:1px solid var(--border);border-radius:var(--r);margin-bottom:7px;cursor:pointer;transition:all .15s;background:var(--s1);}
.history-item:hover{border-color:var(--border2);background:var(--s2);}
.history-item.selected{border-color:var(--accent);background:rgba(232,255,71,.03);}
.hi-date{font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:3px;}
.hi-name{font-size:12px;font-weight:500;margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hi-stats{display:flex;gap:10px;}
.hi-stat{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);}
.hi-stat span{color:var(--text);}

/* Coach main */
.coach-main{display:flex;flex-direction:column;overflow:hidden;}

/* Workout banner */
.workout-banner{padding:0;border-bottom:1px solid var(--border);background:var(--s1);flex-shrink:0;}
.banner-top{display:flex;align-items:center;gap:16px;padding:12px 20px;}
.banner-title{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;}
.banner-stats{display:flex;gap:16px;flex-wrap:wrap;}
.wbs{font-family:IBM Plex Mono,monospace;font-size:10px;color:var(--muted);}
.wbs span{color:var(--text);}
.coach-ind{margin-left:auto;display:flex;align-items:center;gap:7px;font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);}
.ci-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}

/* HR Chart */
.hr-chart-wrap{padding:0 20px 10px;display:none;}
.hr-chart-wrap.visible{display:block;}
.hr-chart-title{font-family:IBM Plex Mono,monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.hr-canvas{width:100%;height:70px;display:block;}
.hr-zones{display:flex;gap:8px;margin-top:4px;flex-wrap:wrap;}
.hz{font-family:IBM Plex Mono,monospace;font-size:8px;padding:2px 6px;border-radius:2px;}

/* Pace breakdown */
.pace-breakdown{padding:0 20px;border-bottom:1px solid var(--border);display:none;overflow:hidden;transition:max-height .3s ease, padding .3s ease;max-height:0;}
.pace-breakdown.visible{display:block;max-height:600px;padding:10px 20px;}
.pace-breakdown.collapsed{max-height:0;padding:0 20px;overflow:hidden;}
.splits-toggle{font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:1px;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:5px;padding:6px 20px;border-bottom:1px solid var(--border);background:var(--s2);user-select:none;}
.splits-toggle:hover{color:var(--text);}
.pb-splits-table{width:100%;border-collapse:collapse;font-family:IBM Plex Mono,monospace;font-size:10px;}
.pb-splits-table th{color:var(--muted);font-size:8px;letter-spacing:1px;text-align:left;padding:2px 8px 6px 0;border-bottom:1px solid var(--border);}
.pb-splits-table td{padding:4px 8px 4px 0;border-bottom:1px solid rgba(255,255,255,.04);}
.pb-split.fast{color:var(--green);}
.pb-split.slow{color:var(--accent2);}

/* Chat */
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;min-height:0;}
.msg{display:flex;gap:10px;max-width:86%;animation:msgIn .3s ease;}
.msg.ai{align-self:flex-start;}
.msg.human-coach{align-self:flex-start;}
.msg.athlete{align-self:flex-end;flex-direction:row-reverse;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}
.msg-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;border:1px solid var(--border);}
.msg-avatar.ai-av{background:rgba(61,158,255,.12);border-color:rgba(61,158,255,.25);}
.msg-avatar.human-av{background:rgba(255,159,67,.12);border-color:rgba(255,159,67,.25);}
.msg-avatar.athlete-av{background:rgba(232,255,71,.08);border-color:rgba(232,255,71,.18);}
.msg-sender{font-family:IBM Plex Mono,monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}
.ai-sender{color:var(--ai-color);}
.human-sender{color:var(--coach-color);}
.athlete-sender{color:var(--muted);text-align:right;}
.msg-bubble{padding:10px 14px;border-radius:var(--r);font-size:13px;line-height:1.6;}
.ai .msg-bubble{background:var(--s2);border:1px solid var(--border);border-top-left-radius:0;}
.human-coach .msg-bubble{background:rgba(255,159,67,.07);border:1px solid rgba(255,159,67,.2);border-top-left-radius:0;}
.athlete .msg-bubble{background:rgba(232,255,71,.07);border:1px solid rgba(232,255,71,.18);border-top-right-radius:0;}

.typing-indicator{display:none;align-self:flex-start;gap:10px;}
.typing-indicator.visible{display:flex;}
.typing-dots{display:flex;gap:3px;align-items:center;padding:10px 14px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);border-top-left-radius:0;}
.typing-dot{width:5px;height:5px;border-radius:50%;background:var(--muted);animation:tp 1.2s infinite;}
.typing-dot:nth-child(2){animation-delay:.2s;}
.typing-dot:nth-child(3){animation-delay:.4s;}
@keyframes tp{0%,60%,100%{opacity:.3;}30%{opacity:1;}}

.suggested-replies{display:flex;gap:5px;flex-wrap:wrap;padding:8px 20px 0;}
.reply-chip{padding:5px 11px;background:var(--s2);border:1px solid var(--border);border-radius:10px;font-size:11px;color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap;}
.reply-chip:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,255,71,.05);}

.chat-input-area{padding:14px 20px;border-top:2px solid var(--border2);background:var(--s1);flex-shrink:0;display:flex;gap:8px;align-items:flex-end;}
.chat-input{flex:1;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:9px 12px;color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:13px;resize:none;outline:none;min-height:40px;max-height:110px;line-height:1.5;transition:border-color .2s;}
.chat-input:focus{border-color:var(--accent);}
.send-btn{background:var(--accent);color:#fff;border:none;border-radius:var(--r);width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0;font-size:15px;}
.send-btn:hover{background:#1d4ed8;transform:scale(1.05);}
.ping-btn{background:rgba(255,159,67,.1);color:var(--orange);border:1px solid rgba(255,159,67,.25);border-radius:var(--r);height:40px;padding:0 12px;font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:1px;cursor:pointer;transition:all .2s;flex-shrink:0;white-space:nowrap;}
.ping-btn:hover{background:rgba(255,159,67,.2);}
.ping-btn.pinged{background:rgba(255,159,67,.2);color:var(--orange);}

/* Right coach panel */
.coach-panel{border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.coach-panel-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.coach-panel-body{flex:1;overflow-y:auto;padding:14px;}
.coach-note{padding:12px;background:rgba(255,159,67,.05);border:1px solid rgba(255,159,67,.15);border-radius:var(--r);margin-bottom:10px;}
.cn-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.cn-coach{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--coach-color);}
.cn-date{font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);}
.cn-text{font-size:12px;line-height:1.6;}

/* Activity exclusion list */
.activity-list-panel{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);margin-top:14px;overflow:hidden;}
.activity-list-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);cursor:pointer;user-select:none;}
.activity-list-header:hover{background:var(--s2);}
.activity-list-toggle{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);letter-spacing:1px;}
.activity-list-body{display:none;max-height:300px;overflow-y:auto;}
.activity-list-body.open{display:block;}
.activity-row{display:grid;grid-template-columns:1fr 60px 70px 65px 26px;gap:6px;align-items:center;padding:8px 16px;border-bottom:1px solid var(--border);transition:background .15s;}
.activity-row:last-child{border-bottom:none;}
.activity-row:hover{background:var(--s2);}
.activity-row.excluded{opacity:.3;text-decoration:line-through;}
.act-name{font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.act-date{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);}
.act-dist{font-family:IBM Plex Mono,monospace;font-size:10px;}
.act-pace{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);}
.act-remove{background:none;border:1px solid var(--border);border-radius:2px;color:var(--muted);font-size:11px;width:20px;height:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;padding:0;}
.act-remove:hover{background:rgba(255,77,46,.15);border-color:var(--accent2);color:var(--accent2);}
.act-remove.restore{color:var(--accent);border-color:var(--muted2);}
.act-remove.restore:hover{background:rgba(232,255,71,.1);border-color:var(--accent);}
.act-list-cols{display:grid;grid-template-columns:1fr 60px 70px 65px 26px;gap:6px;padding:5px 16px;border-bottom:1px solid var(--border);background:var(--s2);}
.act-col-label{font-family:IBM Plex Mono,monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.excluded-count{font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--orange);padding:5px 16px;background:var(--s2);border-top:1px solid var(--border);display:none;}
.excluded-count.visible{display:block;}

/* scrollbar */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

@keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}
.fade-up{animation:fadeUp .4s ease both;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-box fade-up">
    <div class="login-header">
      <div class="login-logo">RunIQ</div>
      <div class="login-sub">Race ¬∑ Plan ¬∑ Coach</div>
      <div style="font-family:IBM Plex Mono,monospace;font-size:10px;color:#444;letter-spacing:2px;">v0.6.5</div>
    </div>
    <div class="login-panels">
      <!-- Athlete Panel -->
      <div class="login-panel">
        <div class="login-panel-title">üèÉ Athlete Login</div>
        <button class="btn-strava" onclick="connectStrava()" style="margin-bottom:10px;">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
          Connect with Strava
        </button>
        <button class="btn-demo" onclick="loadDemoMode()">Continue with Demo Data</button>
        <div id="login-error" style="color:#ff4d4d;font-size:11px;font-family:IBM Plex Mono,monospace;margin-top:10px;display:none;"></div>
      </div>
      <!-- Divider -->
      <div class="login-divider-v"></div>
      <!-- Coach Panel -->
      <div class="login-panel">
        <div class="login-panel-title">‚ö° Coach Login</div>
        <input class="coach-pw-input" type="password" id="home-coach-pw" placeholder="Enter coach password" 
          onkeydown="if(event.key==='Enter')coachLoginFromHome()"/>
        <button class="btn-coach" onclick="coachLoginFromHome()">
          Enter Coach Portal
        </button>
        <div id="coach-login-error" style="color:#ff4d4d;font-size:11px;font-family:IBM Plex Mono,monospace;margin-top:10px;display:none;">Incorrect password</div>
      </div>
    </div>

    <!-- Emergency Deauth -->
    <div style="margin-top:28px;padding-top:20px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div style="font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);letter-spacing:1px;">üîê STRAVA SESSION STUCK?</div>
      <button onclick="emergencyDeauth()" style="font-family:IBM Plex Mono,monospace;font-size:10px;letter-spacing:1px;padding:7px 16px;background:transparent;border:1px solid rgba(239,68,68,.4);border-radius:4px;color:#ef4444;cursor:pointer;transition:all .2s;" onmouseover="this.style.background='rgba(239,68,68,.08)'" onmouseout="this.style.background='transparent'">Disconnect Strava Session</button>
      <div id="deauth-msg" style="font-family:IBM Plex Mono,monospace;font-size:10px;color:var(--green);display:none;">‚úì Session cleared ‚Äî you can reconnect now</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div id="app" style="display:none;">

<nav>
  <a class="nav-logo" href="#">Run<span>IQ</span></a>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="showPage('estimator',this)"><span class="tab-num">01</span> Race Estimator</div>
    <div class="nav-tab" onclick="showPage('plan',this)"><span class="tab-num">02</span> Training Plan</div>
    <div class="nav-tab" onclick="showPage('coach',this)"><span class="tab-num">03</span> AI Coach</div>
  </div>
  <div style="font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted2);letter-spacing:1px;margin-left:12px;">v0.6.5</div>
  <div class="nav-right">
    <a class="nav-coach-link" href="runiq-coach.html?auth=coach123" target="_blank">‚ö° Coach Portal</a>
    <div class="settings-wrap" id="settings-wrap">
      <div class="athlete-chip" id="athlete-chip" onclick="toggleSettings()" style="cursor:pointer;">
        <div class="dot"></div>
        <span id="nav-athlete-name">Loading...</span>
        <span style="font-size:10px;opacity:.6;margin-left:2px;">‚ñæ</span>
      </div>
      <div class="settings-dropdown" id="settings-dropdown">
        <div class="settings-section-label">RACE GOAL</div>
        <input class="settings-input" id="s-race-name" placeholder="Race name (e.g. Boston Marathon)" oninput="debounceSaveSettings()">
        <input class="settings-input" id="s-race-date" type="date" oninput="debounceSaveSettings()">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
          <select class="settings-input" id="s-race-dist" onchange="debounceSaveSettings()" style="margin-bottom:0;">
            <option value="">Distance...</option>
            <option value="5k">5K</option>
            <option value="10k">10K</option>
            <option value="half">Half Marathon</option>
            <option value="marathon">Marathon</option>
            <option value="ultra">Ultra</option>
          </select>
          <input class="settings-input" id="s-goal-time" type="text" placeholder="Goal time (3:25:00)" oninput="debounceSaveSettings()" onchange="saveSettings()" style="margin-bottom:0;">
        </div>
        <div id="s-countdown" style="font-family:IBM Plex Mono,monospace;font-size:10px;color:var(--accent2);padding:4px 0;"></div>
        <div class="settings-divider"></div>
        <div class="settings-section-label">AI COACH PERSONA</div>
        <div id="settings-persona-list"></div>
        <div class="settings-divider"></div>
        <button class="settings-btn-strava" onclick="deauthStrava()">Disconnect Strava</button>
      </div>
    </div>
  </div>
</nav>

<div id="toast" class="toast" aria-live="polite"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 1: ESTIMATOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-estimator">
  <div class="page-header">
    <div>
      <div class="page-eyebrow">Part 01 / Race Intelligence</div>
      <div class="page-title">Race Time <em>Estimator</em></div>
      <div class="page-subtitle">Three models. Taper-aware. Live Strava data.</div>
    </div>
    <button class="btn btn-ghost" onclick="reloadData()">‚Üª Sync Strava</button>
  </div>
  <div class="content">
    <div class="estimator-grid">
      <div>
        <div class="card">
          <div class="card-title">Configuration</div>
          <div class="field">
            <label class="field-label">Method</label>
            <select id="est-method" onchange="updateEstimates()">
              <option value="volume">Volume &amp; Pace</option>
              <option value="ctl">CTL / ATL (Banister)</option>
              <option value="cp">Critical Race Pace</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label">Training Window</label>
            <select id="est-window" onchange="updateEstimates()">
              <option value="4">4 weeks</option>
              <option value="6">6 weeks</option>
              <option value="8" selected>8 weeks</option>
              <option value="10">10 weeks</option>
              <option value="12">12 weeks</option>
            </select>
          </div>
          <div id="method-blurb" style="font-size:11px;color:var(--muted);line-height:1.6;padding:9px 12px;background:var(--s2);border-left:2px solid var(--accent);border-radius:0 3px 3px 0;margin-bottom:14px;"></div>
          <div class="taper-row">
            <div><div style="font-size:13px;font-weight:500;">Currently Tapering</div><div style="font-size:11px;color:var(--muted);margin-top:2px;">Project race-day form</div></div>
            <label class="toggle"><input type="checkbox" id="taper-toggle" onchange="onTaperChange()"><div class="toggle-track"></div></label>
          </div>
          <div class="taper-detail" id="taper-detail">
            <div style="display:flex;align-items:center;gap:8px;font-family:IBM Plex Mono,monospace;font-size:11px;color:var(--muted);">
              Race in <input type="number" id="race-days" value="14" min="1" max="42" style="width:52px;text-align:center;" oninput="updateEstimates()"> days
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Training Summary</div>
          <div class="grid-2" style="gap:7px;">
            <div class="stat-block"><div class="stat-label">Avg / Week</div><div class="stat-value" id="sum-mpw">‚Äî</div><div class="stat-sub">miles/week</div></div>
            <div class="stat-block"><div class="stat-label">Runs</div><div class="stat-value" id="sum-runs">‚Äî</div><div class="stat-sub">this window</div></div>
            <div class="stat-block"><div class="stat-label">Longest Run</div><div class="stat-value" id="sum-long">‚Äî</div><div class="stat-sub">miles</div></div>
            <div class="stat-block"><div class="stat-label">Best Pace</div><div class="stat-value" id="sum-pace">‚Äî</div><div class="stat-sub">/mile</div></div>
          </div>
        </div>
      </div>
      <div>
        <div class="race-cards">
          <div class="race-card" id="card-10k"><div class="race-dist">10K</div><div class="race-time-big" id="t-10k">‚Äî:‚Äî‚Äî</div><div class="race-pace-sub" id="p-10k">‚Äî /mi</div><div class="race-delta" id="d-10k"></div></div>
          <div class="race-card" id="card-hm"><div class="race-dist">Half Marathon</div><div class="race-time-big" id="t-hm">‚Äî:‚Äî‚Äî</div><div class="race-pace-sub" id="p-hm">‚Äî /mi</div><div class="race-delta" id="d-hm"></div></div>
          <div class="race-card" id="card-m"><div class="race-dist">Marathon</div><div class="race-time-big" id="t-m">‚Äî:‚Äî‚Äî</div><div class="race-pace-sub" id="p-m">‚Äî /mi</div><div class="race-delta" id="d-m"></div></div>
        </div>
        <div class="card">
          <div class="card-title">Weekly Volume</div>
          <div style="display:flex;gap:6px;">
            <div style="width:32px;display:flex;flex-direction:column;justify-content:space-between;padding-bottom:16px;">
              <div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);text-align:right;" id="y-top">‚Äî</div>
              <div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);text-align:right;" id="y-mid">‚Äî</div>
            </div>
            <div style="flex:1;">
              <div id="vol-chart" style="height:80px;display:flex;align-items:flex-end;gap:3px;border-left:1px solid var(--border);border-bottom:1px solid var(--border);padding:0 3px;"></div>
              <div id="vol-labels" style="display:flex;gap:3px;padding:0 3px;margin-top:3px;"></div>
            </div>
          </div>
        </div>
        <div class="activity-list-panel">
          <div class="activity-list-header" onclick="toggleActivityList()">
            <div class="card-title" style="margin:0;border:none;">Activities in Window</div>
            <span class="activity-list-toggle" id="act-list-toggle">‚ñ≤ HIDE</span>
          </div>
          <div class="activity-list-body open" id="activity-list-body">
            <div class="act-list-cols">
              <div class="act-col-label">Activity</div>
              <div class="act-col-label">Date</div>
              <div class="act-col-label">Distance</div>
              <div class="act-col-label">Pace</div>
              <div class="act-col-label"></div>
            </div>
            <div id="activity-rows"></div>
            <div class="excluded-count" id="excluded-count"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Method Comparison ‚Äî Marathon</div>
          <div class="grid-3" style="gap:10px;">
            <div style="text-align:center;padding:12px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);"><div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:7px;letter-spacing:2px;">VOLUME</div><div style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;" id="cmp-vol">‚Äî</div></div>
            <div style="text-align:center;padding:12px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);"><div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:7px;letter-spacing:2px;">CTL/ATL</div><div style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;" id="cmp-ctl">‚Äî</div></div>
            <div style="text-align:center;padding:12px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);"><div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:7px;letter-spacing:2px;">CRIT PACE</div><div style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;" id="cmp-cp">‚Äî</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 2: PLAN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-plan">
  <div class="page-header">
    <div>
      <div class="page-eyebrow">Part 02 / Training Intelligence</div>
      <div class="page-title">Your <em>Plan</em></div>
      <div class="page-subtitle">AI generates your week based on your actual recent Strava mileage ‚Äî no jumping from 20 to 80 mpw.</div>
    </div>
  </div>
  <div class="content">
    <div class="plan-builder">
      <div>
        <div id="baseline-banner" class="baseline-banner" style="display:none;"></div>
        <div class="card">
          <div class="card-title">Choose Philosophy</div>
          <div class="philosophy-card selected" onclick="selectPhil(this,'pfitz')">
            <div class="phil-icon">üèîÔ∏è</div>
            <div style="flex:1"><div class="phil-name">Pfitzinger</div><div class="phil-tagline">High mileage, double threshold. Built for serious competitors.</div></div>
            <div class="phil-badge">High Vol</div>
          </div>
          <div class="philosophy-card" onclick="selectPhil(this,'hansons')">
            <div class="phil-icon">‚ö°</div>
            <div style="flex:1"><div class="phil-name">Hansons</div><div class="phil-tagline">Cumulative fatigue. Never fully recovered ‚Äî by design.</div></div>
            <div class="phil-badge">Intense</div>
          </div>
          <div class="philosophy-card" onclick="selectPhil(this,'daniels')">
            <div class="phil-icon">üî¨</div>
            <div style="flex:1"><div class="phil-name">Jack Daniels</div><div class="phil-tagline">VDOT-based zones. Scientific pacing.</div></div>
            <div class="phil-badge">Balanced</div>
          </div>
          <div class="philosophy-card" onclick="selectPhil(this,'canova')">
            <div class="phil-icon">üá∞üá™</div>
            <div style="flex:1"><div class="phil-name">Canova</div><div class="phil-tagline">Race-pace specificity. Kenyan methodology.</div></div>
            <div class="phil-badge">Elite</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Settings</div>
          <div class="field"><label class="field-label">Goal Race</label>
            <select id="plan-goal" onchange="validateGoalTime()"><option>Marathon</option><option>Half Marathon</option><option>10K</option></select></div>
          <div class="field"><label class="field-label">Goal Time</label>
            <div style="display:flex;gap:6px;align-items:center;">
              <input type="number" id="plan-goal-h" min="0" max="9" placeholder="H" style="width:52px;text-align:center;" oninput="validateGoalTime()">
              <span style="font-family:IBM Plex Mono,monospace;color:var(--muted);">:</span>
              <input type="number" id="plan-goal-m" min="0" max="59" placeholder="MM" style="width:60px;text-align:center;" oninput="validateGoalTime()">
              <span style="font-family:IBM Plex Mono,monospace;color:var(--muted);">:</span>
              <input type="number" id="plan-goal-s" min="0" max="59" placeholder="SS" style="width:60px;text-align:center;" oninput="validateGoalTime()">
            </div>
            <div id="goal-time-warn" style="font-family:IBM Plex Mono,monospace;font-size:9px;color:#ef4444;margin-top:4px;display:none;"></div>
          </div>
          <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="generatePlan()">Generate Plan ‚Üí</button>
        </div>
      </div>
      <div id="plan-output">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div style="font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);letter-spacing:2px;">VIEW</div>
          <div style="display:flex;gap:6px;">
            <button id="view-weekly-btn" onclick="setPlanView('weekly')" style="font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:1px;padding:5px 14px;border-radius:2px;border:1px solid var(--accent);background:var(--accent);color:#000;cursor:pointer;">WEEKLY</button>
            <button id="view-monthly-btn" onclick="setPlanView('monthly')" style="font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:1px;padding:5px 14px;border-radius:2px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;">MONTHLY</button>
          </div>
        </div>
        <div id="plan-view-weekly">
          <div class="card" id="plan-card">
            <div class="card-title" id="plan-week-title">Week 1 of 16 ‚Äî Base Building</div>
            <div class="week-grid" id="week-grid"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);">
              <div style="font-family:IBM Plex Mono,monospace;font-size:10px;color:var(--muted);">Total: <span style="color:var(--accent);" id="week-total">‚Äî</span></div>
              <div style="display:flex;gap:7px;">
                <button class="btn btn-ghost" style="padding:7px 12px;font-size:9px;" onclick="changeWeek(-1)">‚Üê Prev</button>
                <button class="btn btn-ghost" style="padding:7px 12px;font-size:9px;" onclick="changeWeek(1)">Next ‚Üí</button>
              </div>
            </div>
          </div>
        </div>
        <div id="plan-view-monthly" style="display:none;">
          <div id="monthly-grid"></div>
        </div>
        <div class="card">
          <div class="card-title">16-Week Phase Overview</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
            <div style="padding:12px;background:var(--s2);border:1px solid rgba(232,255,71,.2);border-radius:var(--r);border-top:3px solid var(--accent);"><div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:4px;">WKS 1‚Äì5</div><div style="font-weight:500;font-size:12px;margin-bottom:3px;">Base Building</div><div style="font-size:10px;color:var(--muted);">Aerobic foundation</div></div>
            <div style="padding:12px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);border-top:3px solid var(--blue);"><div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:4px;">WKS 6‚Äì11</div><div style="font-weight:500;font-size:12px;margin-bottom:3px;">Lactate Dev</div><div style="font-size:10px;color:var(--muted);">Tempo + threshold</div></div>
            <div style="padding:12px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);border-top:3px solid var(--accent2);"><div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:4px;">WKS 12‚Äì14</div><div style="font-weight:500;font-size:12px;margin-bottom:3px;">Race Specific</div><div style="font-size:10px;color:var(--muted);">MP runs, tune-up</div></div>
            <div style="padding:12px;background:var(--s2);border:1px solid var(--border);border-radius:var(--r);border-top:3px solid var(--orange);"><div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:4px;">WKS 15‚Äì16</div><div style="font-weight:500;font-size:12px;margin-bottom:3px;">Taper</div><div style="font-size:10px;color:var(--muted);">Sharpen &amp; peak</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 3: COACH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-coach">
  <div class="coach-layout">

    <!-- Left sidebar -->
    <div class="coach-sidebar">
      <!-- Rx Weekly Panel -->
      <div class="rx-week-toggle" id="rx-week-toggle" onclick="toggleRxPanel()" style="display:none;">
        <div style="flex:1;">
          <div class="sidebar-label" style="margin-bottom:1px;">üìã This Week's Prescription</div>
          <div id="rx-week-summary" style="font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);">Loading...</div>
        </div>
        <span id="rx-toggle-arrow" style="color:var(--muted);font-size:10px;">‚ñº</span>
      </div>
      <div id="rx-week-panel" style="display:none;border-bottom:1px solid var(--border);overflow-y:auto;max-height:320px;"></div>
      <!-- Recent Workouts -->
      <div style="padding:10px 14px 6px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
        <div class="sidebar-label" style="margin-bottom:0;">Recent Workouts</div>
      </div>
      <div class="workout-history" id="workout-history"></div>
    </div>

    <!-- Main chat -->
    <div class="coach-main">
      <div class="workout-banner">
        <div class="banner-top">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:10px;">
              <div class="banner-title" id="banner-title">Loading workout...</div>
              <a id="strava-banner-link" href="#" target="_blank" style="font-family:IBM Plex Mono,monospace;font-size:9px;color:#fc4c02;text-decoration:none;padding:2px 8px;border:1px solid rgba(252,76,2,.3);border-radius:2px;display:none;transition:all .15s;" onmouseover="this.style.background='rgba(252,76,2,.1)'" onmouseout="this.style.background='transparent'">‚Üó Strava</a>
            </div>
            <div class="banner-stats" id="banner-stats"></div>
          </div>
          <div class="coach-ind">
            <div class="ci-dot" style="background:var(--ai-color);"></div>AI Coach
            <div style="width:1px;height:12px;background:var(--border);margin:0 3px;"></div>
            <div class="ci-dot" style="background:var(--orange);"></div>Coach
          </div>
        </div>
        <div class="splits-toggle" id="splits-toggle" onclick="toggleSplits()" style="display:none;">
          <span id="splits-toggle-icon">‚ñ≤</span> <span id="splits-toggle-label">SPLITS</span>
        </div>
        <div class="pace-breakdown" id="pace-breakdown"></div>
        <div class="hr-chart-wrap" id="hr-chart-wrap">
          <div class="hr-chart-title" style="display:flex;justify-content:space-between;align-items:center;">
            <span>Heart Rate + Pace ‚Äî <span id="hr-chart-label">this workout</span></span>
            <div id="chart-tooltip" style="font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--accent);letter-spacing:1px;display:none;"></div>
          </div>
          <div style="position:relative;">
            <canvas class="hr-canvas" id="hr-canvas" height="80" style="height:80px;"></canvas>
          </div>
          <div class="hr-zones" id="hr-zones"></div>
        </div>
      </div>

      <div id="analyze-bar" style="padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--s2);">
        <div style="font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--muted);letter-spacing:1px;">Select a workout then analyze</div>
        <button id="analyze-btn" onclick="analyzeWorkout()" style="font-family:IBM Plex Mono,monospace;font-size:10px;letter-spacing:2px;background:var(--accent);color:#000;border:none;padding:6px 18px;border-radius:2px;cursor:pointer;font-weight:700;">‚ö° ANALYZE</button>
      </div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="typing-indicator" id="typing-ind">
        <div class="msg-avatar ai-av">ü§ñ</div>
        <div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
      </div>
      <div class="suggested-replies" id="suggested-replies"></div>
      <div class="chat-input-area">
        <textarea class="chat-input" id="chat-input" placeholder="Talk to your coach..." rows="1"
          onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
        <button class="ping-btn" id="ping-btn" onclick="pingCoach()">@ Coach</button>
        <button class="send-btn" onclick="sendMessage()">‚Üë</button>
      </div>
    </div>

    <!-- Right coach panel -->
    <div class="coach-panel">
      <div class="coach-panel-header">
        <div style="font-family:IBM Plex Mono,monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Head Coach</div>
        <div style="display:flex;align-items:center;gap:6px;font-family:IBM Plex Mono,monospace;font-size:9px;padding:3px 8px;border-radius:8px;background:rgba(255,159,67,.1);border:1px solid rgba(255,159,67,.25);color:var(--orange);">
          <div class="ci-dot" style="background:var(--orange);"></div>Coach Mike
        </div>
      </div>
      <div class="coach-panel-body">
        <div style="margin-bottom:14px;">
          <div style="font-family:IBM Plex Mono,monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Weekly Summary</div>
          <div id="weekly-summary-panel"></div>
        </div>
        <div>
          <div style="font-family:IBM Plex Mono,monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Coach Notes</div>
          <div id="coach-notes-panel">
            <div class="coach-note"><div class="cn-header"><div class="cn-coach">Coach Mike</div><div class="cn-date">3 days ago</div></div><div class="cn-text">Looking solid this week. Keep easy runs genuinely easy ‚Äî HR under 145. Thursday speed work will hit harder if you're recovered properly.</div></div>
          </div>
        </div>
        <div style="margin-top:14px;padding:12px;background:rgba(61,158,255,.05);border:1px solid rgba(61,158,255,.12);border-radius:var(--r);">
          <div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--ai-color);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;">AI ‚Üí Coach Handoff</div>
          <div id="ai-handoff" style="font-size:11px;line-height:1.6;color:var(--muted);">Waiting for workout data...</div>
        </div>
      </div>
    </div>

  </div>
</div>

</div><!-- /app -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STRAVA_CLIENT_ID = '%%STRAVA_CLIENT_ID%%';

// ‚îÄ‚îÄ YOUR API KEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ANTHROPIC_API_KEY = 'YOUR_KEY_HERE'; // ‚Üê paste your key here
const REDIRECT_URI = window.location.origin + '/';
const SCOPE = 'activity:read_all';
const STRAVA_AUTH_URL = 'https://www.strava.com/oauth/authorize';
const STRAVA_API = 'https://www.strava.com/api/v3';

const APP = {
  accessToken: '',
  athlete: null,
  activities: [],   // raw Strava activities
  demoMode: false,
  currentWorkout: null,
  currentPersona: 'neighborbob',
  chatHistory: [],
  chatInitialized: false,
  analyzedWorkouts: {},
  _analyzed: false,
  _chatRunning: false,
  _lastChatWorkoutId: null,
  _workoutSelectSeq: 0,
  weeklyMi: [],
  excluded: new Set(),
};

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  // Check for OAuth callback
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if (code) {
    window.history.replaceState({}, '', '/');
    exchangeToken(code);
    return;
  }
  // Check saved token
  const token = localStorage.getItem('runiq_token');
  if (token) {
    APP.accessToken = token;
    bootApp();
  }
});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectStrava() {
  const authUrl = `${STRAVA_AUTH_URL}?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=${SCOPE}`;
  window.location.href = authUrl;
}

function deauthStrava() {
  if (!confirm('Disconnect Strava? You will need to reconnect to use RunIQ.')) return;
  localStorage.removeItem('runiq_token');
  localStorage.removeItem('runiq_settings');
  location.reload();
}

function emergencyDeauth() {
  localStorage.removeItem('runiq_token');
  localStorage.removeItem('runiq_settings');
  const msg = document.getElementById('deauth-msg');
  if (msg) { msg.style.display = 'block'; }
  // Brief pause then allow reconnect without full reload
  setTimeout(() => {
    if (msg) msg.style.display = 'none';
  }, 4000);
}

async function exchangeToken(code) {
  showLoginMsg('Authenticating with Strava...');
  try {
    const res = await fetch('/api/callback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    const data = await res.json();
    if (data.access_token) {
      APP.accessToken = data.access_token;
      localStorage.setItem('runiq_token', data.access_token);
      bootApp();
    } else {
      showLoginMsg('Auth failed: ' + (data.error || 'Unknown error'), true);
    }
  } catch(e) {
    showLoginMsg('Auth failed: ' + e.message, true);
  }
}

function showLoginMsg(msg, isError) {
  const el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = 'block';
  el.style.color = isError ? '#ff4d4d' : 'var(--muted)';
}

// ‚îÄ‚îÄ DEMO MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadDemoMode() {
  APP.demoMode = true;
  APP.athlete = { firstname: 'Demo', lastname: 'Athlete', id: 0, city: 'Los Angeles', country: 'USA', profile_medium: '' };
  APP.activities = generateDemoActivities();
  bootApp();
}

function generateDemoActivities() {
  const acts = [];
  const now = Date.now();
  const types = [
    { name:'Easy Run', effort:'easy', secPerMi:540, distMi:5.5 },
    { name:'Tempo Run', effort:'tempo', secPerMi:448, distMi:7.8 },
    { name:'Long Run', effort:'long', secPerMi:533, distMi:14 },
    { name:'Speed Work', effort:'vo2', secPerMi:430, distMi:7 },
    { name:'Recovery Jog', effort:'easy', secPerMi:581, distMi:4.5 },
  ];
  // 12 weeks of data, ~5 runs/week
  for (let w = 0; w < 12; w++) {
    const runsThisWeek = 4 + Math.floor(Math.random()*2);
    for (let r = 0; r < runsThisWeek; r++) {
      const t = types[Math.floor(Math.random()*types.length)];
      const distMi = t.distMi * (0.85 + Math.random()*.3);
      const distM = distMi * 1609.34;
      const movSec = Math.round(distMi * t.secPerMi * (0.95 + Math.random()*.1));
      const daysAgo = w * 7 + r * 1.4;
      const hrBase = t.effort === 'easy' ? 135 : t.effort === 'tempo' ? 158 : t.effort === 'vo2' ? 172 : 140;
      // Generate fake laps for pace breakdown
      const lapCount = Math.max(1, Math.round(distMi));
      const laps = Array.from({length: lapCount}, (_, i) => ({
        distance: Math.min(1609.34, distM - i*1609.34),
        elapsed_time: Math.round(t.secPerMi * (0.95 + Math.random()*.1)),
        average_heartrate: hrBase + Math.round((Math.random()-0.5)*12),
      }));
      acts.push({
        id: now - w*1000000 - r*1000,
        name: t.name,
        type: 'Run',
        sport_type: 'Run',
        start_date: new Date(now - daysAgo * 86400000).toISOString(),
        distance: distM,
        moving_time: movSec,
        average_heartrate: hrBase + Math.round((Math.random()-0.5)*8),
        max_heartrate: hrBase + 20 + Math.round(Math.random()*15),
        average_cadence: 168 + Math.round((Math.random()-0.5)*10),
        _effort: t.effort,
        laps,
        // synthesized HR stream
        _hrStream: generateHRStream(hrBase, movSec),
      });
    }
  }
  return acts.sort((a,b) => new Date(b.start_date) - new Date(a.start_date));
}

function generateHRStream(base, duration) {
  const points = 40;
  const stream = [];
  let hr = base - 10;
  for (let i = 0; i < points; i++) {
    hr += (Math.random() - 0.4) * 4;
    hr = Math.max(base - 15, Math.min(base + 25, hr));
    // warmup/cooldown shape
    const pct = i / points;
    if (pct < 0.15) hr = base - 10 + pct / 0.15 * 12;
    if (pct > 0.85) hr -= (pct - 0.85) / 0.15 * 10;
    stream.push(Math.round(hr));
  }
  return stream;
}

// ‚îÄ‚îÄ BOOT APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function bootApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';

  if (!APP.demoMode) {
    await loadStravaData();
  } else {
    APP.excluded = new Set();
    finalizeApp();
  }
}

async function loadStravaData() {
  showLoginMsg('Loading your Strava data...');
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';

  try {
    // Athlete profile
    APP.athlete = await stravaGet('/athlete');

    // Activities ‚Äî 16 weeks back
    const acts = await stravaGet('/athlete/activities?per_page=200');
    APP.activities = acts.filter(a => a.type === 'Run' || a.sport_type === 'Run');

    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    finalizeApp();
  } catch(e) {
    if (e.message.includes('401')) {
      localStorage.removeItem('runiq_token');
    }
    showLoginMsg('Error loading data: ' + e.message, true);
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
  }
}

async function reloadData() {
  if (APP.demoMode) return;
  await loadStravaData();
}

function finalizeApp() {
  // Athlete name in nav
  const name = APP.athlete ? `${APP.athlete.firstname} ${APP.athlete.lastname}` : 'Athlete';
  document.getElementById('nav-athlete-name').textContent = name;

  // Load settings (persona, race goal, countdown)
  buildPersonaDropdown();
  migrateLegacyWorkoutChats().catch(() => {});

  // Sync athlete data to KV (so coach can see it)
  syncAthleteToKV();

  // Run estimator
  updateEstimates();

  // Generate default plan
  generatePlan();

  // Initialize coach page
  buildWorkoutHistory();

  // Load prescribed workouts for the week
  loadPrescribedWeek(); // loads for real users, shows placeholder for demo
  startRxPolling();

  // Show baseline banner on plan page
  updateBaselineBanner();
}

// ‚îÄ‚îÄ COACH LOGIN FROM HOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function coachLoginFromHome() {
  const pw = document.getElementById('home-coach-pw').value;
  if (pw === 'coach123') {
    window.location.href = 'runiq-coach.html?auth=coach123';
  } else {
    const err = document.getElementById('coach-login-error');
    err.style.display = 'block';
    setTimeout(() => err.style.display = 'none', 2000);
  }
}

// ‚îÄ‚îÄ KV SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncAthleteToKV() {
  if (!APP.athlete || !APP.activities.length) return;
  try {
    await fetch('/api/athlete-sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        athlete: APP.athlete,
        activities: APP.activities
      })
    });
    console.log('Synced to KV');
  } catch(e) {
    console.warn('KV sync failed:', e);
  }
}

function getThreadStorageKey() {
  if (!APP.athlete || !APP.athlete.id) return null;
  return `runiq_chat_thread_${APP.athlete.id}`;
}

async function saveChat(workoutId, messages) {
  if (!APP.athlete) return;
  try {
    const body = workoutId
      ? { athleteId: APP.athlete.id, workoutId, messages }
      : { athleteId: APP.athlete.id, action: 'save_timeline', messages };
    await fetch('/api/chat-history', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
  } catch(e) {
    console.warn('Chat save failed:', e);
  }
}

async function migrateLegacyWorkoutChats() {
  if (!APP.athlete || !APP.athlete.id) return;
  const athleteId = APP.athlete.id;
  const unifiedKey = getThreadStorageKey();
  if (!unifiedKey) return;
  const markerKey = `runiq_chat_migrated_${athleteId}`;
  if (localStorage.getItem(markerKey)) return;

  const parsePayload = (raw) => {
    if (!raw) return null;
    try { return JSON.parse(raw); } catch(e) { return null; }
  };
  const normalizeRole = (m) => (m?.role === 'assistant' ? 'assistant' : 'user');

  const merged = [];
  let tsSeed = Date.now() - 100000;

  const existingUnified = parsePayload(localStorage.getItem(unifiedKey));
  if (existingUnified && Array.isArray(existingUnified.history)) {
    existingUnified.history.forEach((m, i) => {
      if (!m || !m.content) return;
      merged.push({
        role: normalizeRole(m),
        content: m.content,
        workoutId: m.workoutId || null,
        _ts: Number(m.timestamp || existingUnified.ts || tsSeed) + i
      });
    });
  }

  const legacyKeys = [];
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (!k) continue;
    if (/^runiq_chat_\d+$/.test(k) || /^chat_\d+$/.test(k)) legacyKeys.push(k);
  }

  legacyKeys.forEach((k) => {
    const payload = parsePayload(localStorage.getItem(k));
    if (!payload || !Array.isArray(payload.history)) return;
    const match = k.match(/(\d+)$/);
    const workoutId = match ? match[1] : null;
    const baseTs = Number(payload.ts || tsSeed);
    payload.history.forEach((m, idx) => {
      if (!m || !m.content) return;
      merged.push({
        role: normalizeRole(m),
        content: m.content,
        workoutId,
        _ts: baseTs + idx
      });
    });
    tsSeed += 1000;
  });

  if (!merged.length) {
    localStorage.setItem(markerKey, '1');
    return;
  }

  merged.sort((a, b) => a._ts - b._ts);
  const deduped = [];
  const seen = new Set();
  merged.forEach((m) => {
    const sig = `${m.role}|${m.content}|${m.workoutId || ''}`;
    if (seen.has(sig)) return;
    seen.add(sig);
    deduped.push(m);
  });

  const unifiedHistory = deduped.map(m => ({ role: m.role, content: m.content, workoutId: m.workoutId || null, timestamp: new Date(m._ts).toISOString() }));
  localStorage.setItem(unifiedKey, JSON.stringify({ history: unifiedHistory, ts: Date.now() }));
  localStorage.setItem(markerKey, '1');

  // Seed KV timeline once if it doesn't already exist.
  try {
    const res = await fetch(`/api/chat-history?athleteId=${athleteId}`);
    const data = res.ok ? await res.json() : null;
    if (!data || !Array.isArray(data.messages) || !data.messages.length) {
      const timelineMessages = unifiedHistory.map(m => ({
        role: m.role,
        sender: m.role === 'assistant' ? 'ai' : 'athlete',
        content: m.content,
        timestamp: m.timestamp,
        workoutId: m.workoutId || null
      }));
      await saveChat(null, { messages: timelineMessages, migratedAt: new Date().toISOString() });
    }
  } catch(e) {}
}

function getWorkoutContextLabel() {
  if (!APP.currentWorkout) return '';
  return `${APP.currentWorkout.name || 'Workout'} ¬∑ ${actToMi(APP.currentWorkout).toFixed(1)}mi ¬∑ ${fmtPace(actPaceMi(APP.currentWorkout))}/mi`;
}

async function appendTimelineMessage(sender, content) {
  if (!APP.athlete || !APP.athlete.id || !content) return;
  try {
    await fetch('/api/chat-history', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        athleteId: APP.athlete.id,
        action: 'append',
        message: {
          role: sender === 'ai' ? 'assistant' : 'user',
          sender,
          content,
          timestamp: new Date().toISOString(),
          workoutId: APP.currentWorkout?.id || null,
          workoutContext: getWorkoutContextLabel()
        }
      })
    });
  } catch(e) {
    console.warn('Timeline append failed:', e);
  }
}

// ‚îÄ‚îÄ STRAVA API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function stravaGet(path) {
  const res = await fetch(`${STRAVA_API}${path}`, {
    headers: { Authorization: `Bearer ${APP.accessToken}` }
  });
  if (res.status === 401) throw new Error('401 - Token expired');
  if (!res.ok) throw new Error(`Strava error ${res.status}`);
  return res.json();
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if (el) el.classList.add('active');
  if (id === 'coach') {
    setTimeout(() => {
      if (APP.activities && APP.activities.length) {
        initCoachChat();
      }
    }, 300);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 1: ESTIMATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const METHOD_DESC = {
  volume: 'Uses your best recent efforts at each distance. Directly grounded in your actual pace data.',
  ctl: 'Chronic Training Load model. Uses your fitness-fatigue balance as a modifier on pace data.',
  cp: 'Fits a 2-parameter Critical Pace curve to all efforts. CP = sustainable ceiling, D‚Ä≤ = anaerobic reserve.',
};

function onTaperChange() {
  const on = document.getElementById('taper-toggle').checked;
  document.getElementById('taper-detail').className = `taper-detail${on?' open':''}`;
  updateEstimates();
}

function actToMi(a) { return (a.distance || 0) / 1609.34; }
function actPaceMi(a) { return a.moving_time / actToMi(a); }

function updateEstimates() {
  const method = document.getElementById('est-method').value;
  const weeks = parseInt(document.getElementById('est-window').value);
  const tapering = document.getElementById('taper-toggle').checked;
  const raceDays = parseInt(document.getElementById('race-days').value) || 14;

  document.getElementById('method-blurb').textContent = METHOD_DESC[method];

  renderActivityList();
  if (!APP.activities.length) return;

  // Filter to window
  const cutoff = Date.now() - weeks * 7 * 86400000;
  const recent = APP.activities.filter(a => new Date(a.start_date) >= cutoff && !APP.excluded.has(a.id));

  if (!recent.length) return;

  // Stats
  const totalMi = recent.reduce((s,a) => s + actToMi(a), 0);
  const avgMpw = totalMi / weeks;
  const longest = Math.max(...recent.map(actToMi));
  const bestPace = Math.min(...recent.filter(a => actToMi(a) > 0.5).map(actPaceMi));

  document.getElementById('sum-mpw').textContent = avgMpw.toFixed(1);
  document.getElementById('sum-runs').textContent = recent.length;
  document.getElementById('sum-long').textContent = longest.toFixed(1);
  document.getElementById('sum-pace').textContent = fmtPace(bestPace);

  // Estimate race times
  const base = estimateFromData(recent, weeks, method, avgMpw);
  if (!base) return;

  const mods = { volume: 1.0, ctl: 1.008, cp: 1.018 };
  let { t10k, thm, tm } = { t10k: base.t10k * mods[method], thm: base.thm * mods[method], tm: base.tm * mods[method] };

  // Method comparison
  document.getElementById('cmp-vol').textContent = fmtTime(base.tm * 1.0);
  document.getElementById('cmp-ctl').textContent = fmtTime(base.tm * 1.008);
  document.getElementById('cmp-cp').textContent  = fmtTime(base.tm * 1.018);

  let taperBonus = 0;
  if (tapering) {
    taperBonus = Math.min(0.03, raceDays / 14 * 0.015 + 0.01);
    t10k *= (1-taperBonus); thm *= (1-taperBonus); tm *= (1-taperBonus);
  }

  const pairs = [
    { id:'10k', t:t10k, base:base.t10k, dist:6.2137 },
    { id:'hm',  t:thm,  base:base.thm,  dist:13.1094 },
    { id:'m',   t:tm,   base:base.tm,   dist:26.2188 },
  ];
  pairs.forEach(p => {
    document.getElementById(`t-${p.id}`).textContent = fmtTime(p.t);
    document.getElementById(`t-${p.id}`).className = `race-time-big${tapering?' taper':''}`;
    document.getElementById(`p-${p.id}`).textContent = fmtPaceMiDist(p.t, p.dist);
    document.getElementById(`card-${p.id}`).className = 'race-card live';
    if (tapering) {
      const diff = p.base * mods[method] - p.t;
      const m = Math.floor(diff/60), s = Math.round(diff%60);
      document.getElementById(`d-${p.id}`).textContent = `‚àí${m}m ${s}s`;
    } else {
      document.getElementById(`d-${p.id}`).textContent = '';
    }
  });

  drawVolChart(weeks);

  // Save race estimator outputs so coach portal uses athlete-side estimator data
  if (APP.athlete && APP.athlete.id && APP.athlete.id !== 1 && t10k && thm && tm) {
    const raceEstimates = {
      t10k: fmtTime(t10k),
      thm: fmtTime(thm),
      tm: fmtTime(tm)
    };
    fetch('/api/athlete-memory', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        athleteId: APP.athlete.id,
        action: 'add_note',
        data: { key: 'raceEstimates', value: raceEstimates }
      })
    }).catch(() => {});
  }
}

function estimateFromData(acts, weeks, method, avgMpw) {
  if (!avgMpw || avgMpw < 0.1) return null;

  // acts is already filtered to the selected window + excluded set
  // Use all runs >= 2 miles in the window
  const raceableRuns = acts.filter(a => actToMi(a) >= 2.0);
  if (!raceableRuns.length) return null;

  // Weighted average pace ‚Äî weight longer runs more heavily
  const totalWeight = raceableRuns.reduce((s,a) => s + actToMi(a), 0);
  const repPace = raceableRuns.reduce((s,a) => s + actPaceMi(a) * actToMi(a), 0) / totalWeight;

  // Longest run in window for Riegel scaling
  const maxDist = Math.max(...raceableRuns.map(actToMi));

  // Riegel formula: T2 = T1 * (D2/D1)^1.06
  const pace10k = repPace * Math.pow(6.2137 / Math.max(maxDist, 6.2137), 0.06);
  const t10k = pace10k * 6.2137;
  const thm  = pace10k * 13.1094 * Math.pow(13.1094/6.2137, 0.06);
  const tm   = pace10k * 26.2188 * Math.pow(26.2188/6.2137, 0.06);

  // Mileage modifier ‚Äî lower mileage = slower marathon projection
  const mpwFactor = Math.min(1.0, 0.80 + avgMpw/160);
  return { t10k, thm, tm: tm / mpwFactor };
}

function drawVolChart(activeWeeks) {
  const chart = document.getElementById('vol-chart');
  const labels = document.getElementById('vol-labels');
  chart.innerHTML = ''; labels.innerHTML = '';

  if (!APP.activities.length) return;

  // Build 12 weeks using Monday-anchored calendar weeks
  const numWeeks = 12;
  const weekMi = Array(numWeeks).fill(0);
  const now = new Date();
  // Find START of current week (Monday at 00:00:00)
  const dow = (now.getDay() + 6) % 7; // Mon=0 ... Sun=6
  const weekStart = new Date(now);
  weekStart.setHours(0, 0, 0, 0);
  weekStart.setDate(weekStart.getDate() - dow);
  const weekStartMs = weekStart.getTime();

  APP.activities.forEach(a => {
    const actMs = new Date(a.start_date).getTime();
    const msAgo = weekStartMs - actMs;
    if (msAgo < 0) {
      // This week (current)
      weekMi[numWeeks - 1] += actToMi(a);
    } else {
      const wk = Math.floor(msAgo / (7 * 86400000)) + 1;
      if (wk < numWeeks) weekMi[numWeeks - 1 - wk] += actToMi(a);
    }
  });

  const maxMi = Math.max(...weekMi, 1);
  const yMax = Math.ceil(maxMi/10)*10;
  document.getElementById('y-top').textContent = yMax+'mi';
  document.getElementById('y-mid').textContent = Math.round(yMax/2)+'mi';
  APP.weeklyMi = weekMi;

  weekMi.forEach((mi, i) => {
    const wksAgo = numWeeks - 1 - i;
    const isActive = wksAgo < activeWeeks;
    const h = Math.max(2, Math.round((mi/yMax)*80));
    const bar = document.createElement('div');
    bar.style.cssText = `flex:1;height:${h}px;background:${isActive?'rgba(232,255,71,.7)':'var(--muted2)'};border-radius:2px 2px 0 0;transition:height .4s;`;
    bar.title = `${wksAgo===0?'This week':wksAgo+'w ago'}: ${mi.toFixed(1)} mi`;
    chart.appendChild(bar);
    const lbl = document.createElement('div');
    lbl.style.cssText = `flex:1;font-family:IBM Plex Mono,monospace;font-size:8px;color:${isActive?'var(--accent)':'var(--muted)'};text-align:center;`;
    lbl.textContent = mi > 0.5 ? Math.round(mi) : '';
    labels.appendChild(lbl);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 2: PLAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentPhil = 'pfitz';

function selectPhil(el, phil) {
  document.querySelectorAll('.philosophy-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  currentPhil = phil;
  generatePlan();
}

function getRecentRunsForPlan() {
  const twoWeeksAgo = Date.now() - 14 * 86400000;
  return APP.activities
    .filter(a => new Date(a.start_date) >= twoWeeksAgo)
    .map(a => ({ name: a.name, distanceMi: actToMi(a), pace: actPaceMi(a), date: a.start_date }));
}

function updateBaselineBanner() {
  const recent = getRecentRunsForPlan();
  if (!recent.length) return;
  const totalMi = recent.reduce((s,r) => s + r.distanceMi, 0);
  const avgMpw = totalMi / 2;
  const maxSafe = (avgMpw * 1.1 + 5).toFixed(0);
  const banner = document.getElementById('baseline-banner');
  banner.style.display = 'block';
  banner.innerHTML = `üìä <strong>Your baseline:</strong> ~${avgMpw.toFixed(0)} mi/week (last 2 weeks) ¬∑ Max safe next week: <strong>${maxSafe} mi</strong> ¬∑ Plan generated to match your actual fitness.`;
}

// Goal-time minimums per distance (in seconds)
const GOAL_TIME_MINS = { 'Marathon': 2*3600, 'Half Marathon': 55*60, '10K': 25*60 };
const GOAL_TIME_LABELS = { 'Marathon': '2:00:00', 'Half Marathon': '0:55:00', '10K': '0:25:00' };

function validateGoalTime() {
  const dist = document.getElementById('plan-goal')?.value || 'Marathon';
  const h = parseInt(document.getElementById('plan-goal-h')?.value) || 0;
  const m = parseInt(document.getElementById('plan-goal-m')?.value) || 0;
  const s = parseInt(document.getElementById('plan-goal-s')?.value) || 0;
  const totalSec = h * 3600 + m * 60 + s;
  const warn = document.getElementById('goal-time-warn');
  if (!warn) return;
  if (totalSec > 0 && totalSec < GOAL_TIME_MINS[dist]) {
    warn.textContent = `‚ö† ${dist} goal time can't be under ${GOAL_TIME_LABELS[dist]}`;
    warn.style.display = 'block';
  } else {
    warn.style.display = 'none';
  }
}

function getGoalTimeStr() {
  const h = parseInt(document.getElementById('plan-goal-h')?.value) || 0;
  const m = parseInt(document.getElementById('plan-goal-m')?.value) || 0;
  const s = parseInt(document.getElementById('plan-goal-s')?.value) || 0;
  return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function generatePlan() {
  const recent = getRecentRunsForPlan();
  const ctx = typeof RUNIQ_KB !== 'undefined' ? RUNIQ_KB.getPlanContext(recent) : '';
  const totalMi = recent.reduce((s,r) => s + r.distanceMi, 0);
  const avgMpw = recent.length ? totalMi / 2 : 30;
  const maxMi = Math.min(avgMpw * 1.1 + 5, 999);

  // Scale plan to athlete baseline
  const scale = Math.min(1, maxMi / 59); // 59 = full Pfitz week base

  const PLANS = {
    pfitz: [
      { day:'Mon', name:'Rest / Cross-Train', type:'rest', dist:'' },
      { day:'Tue', name:`${Math.round(8*scale)}mi w/ 5√ó1200m @ 5K pace`, type:'vo2', dist:`${Math.round(8*scale)} mi` },
      { day:'Wed', name:'Medium-Long Easy', type:'easy', dist:`${Math.round(12*scale)} mi` },
      { day:'Thu', name:`Lactate Threshold ${Math.round(10*scale)}mi`, type:'tempo', dist:`${Math.round(10*scale)} mi` },
      { day:'Fri', name:'Recovery Run', type:'easy', dist:`${Math.round(5*scale)} mi` },
      { day:'Sat', name:'General Aerobic', type:'easy', dist:`${Math.round(8*scale)} mi` },
      { day:'Sun', name:'Long Run', type:'long', dist:`${Math.round(16*scale)} mi` },
    ],
    hansons: [
      { day:'Mon', name:'Rest', type:'rest', dist:'' },
      { day:'Tue', name:`Speed: ${Math.round(6*scale)}√ó1mi @ 10K pace`, type:'vo2', dist:`${Math.round(10*scale)} mi` },
      { day:'Wed', name:'Easy Recovery', type:'easy', dist:`${Math.round(6*scale)} mi` },
      { day:'Thu', name:`Strength: MP+10s ‚Äî ${Math.round(8*scale)}mi`, type:'tempo', dist:`${Math.round(12*scale)} mi` },
      { day:'Fri', name:'Easy Run', type:'easy', dist:`${Math.round(6*scale)} mi` },
      { day:'Sat', name:'Easy Run', type:'easy', dist:`${Math.round(7*scale)} mi` },
      { day:'Sun', name:'Long Run', type:'long', dist:`${Math.round(15*scale)} mi` },
    ],
    daniels: [
      { day:'Mon', name:'Easy + Strides', type:'easy', dist:`${Math.round(7*scale)} mi` },
      { day:'Tue', name:'T-pace repeats 5√ó1mi', type:'tempo', dist:`${Math.round(10*scale)} mi` },
      { day:'Wed', name:'Easy', type:'easy', dist:`${Math.round(8*scale)} mi` },
      { day:'Thu', name:'I-pace 5√ó1200m + R 8√ó200', type:'vo2', dist:`${Math.round(10*scale)} mi` },
      { day:'Fri', name:'Easy', type:'easy', dist:`${Math.round(6*scale)} mi` },
      { day:'Sat', name:'Easy + Strides', type:'easy', dist:`${Math.round(7*scale)} mi` },
      { day:'Sun', name:'Long Easy Run', type:'long', dist:`${Math.round(18*scale)} mi` },
    ],
    canova: [
      { day:'Mon', name:'Easy Regeneration', type:'easy', dist:`${Math.round(8*scale)} mi` },
      { day:'Tue', name:`General Endurance @ MP+30s`, type:'tempo', dist:`${Math.round(14*scale)} mi` },
      { day:'Wed', name:'Easy', type:'easy', dist:`${Math.round(8*scale)} mi` },
      { day:'Thu', name:`Special Endurance @ MP+15s`, type:'tempo', dist:`${Math.round(10*scale)} mi` },
      { day:'Fri', name:'Easy', type:'easy', dist:`${Math.round(6*scale)} mi` },
      { day:'Sat', name:'Fundamental Run + drills', type:'easy', dist:`${Math.round(10*scale)} mi` },
      { day:'Sun', name:'Long Competition-Specific', type:'long', dist:`${Math.round(20*scale)} mi` },
    ],
  };

  const plan = PLANS[currentPhil];
  const grid = document.getElementById('week-grid');
  grid.innerHTML = '';
  let total = 0;
  plan.forEach(day => {
    const miles = parseFloat(day.dist) || 0;
    total += miles;
    const d = document.createElement('div');
    d.className = 'day-block';
    d.innerHTML = `<div class="day-name">${day.day}</div><div class="day-type ${day.type}">${day.type}</div><div class="day-workout">${day.name}</div>${day.dist?`<div class="day-dist">${day.dist}</div>`:''}`;
    grid.appendChild(d);
  });
  document.getElementById('week-total').textContent = total.toFixed(0) + ' mi';
  APP._currentWeek = 1;
  APP._currentPhilPlan = plan;
  document.getElementById('plan-week-title').textContent = `${getWeekDateLabel(1)} ‚Äî Base Building`;
}

function getWeekDateLabel(weekNum) {
  // Week 1 = current week (anchored to this Monday)
  const now = new Date();
  const dow = (now.getDay() + 6) % 7; // 0=Mon
  const thisMonday = new Date(now);
  thisMonday.setDate(now.getDate() - dow + (weekNum - 1) * 7);
  thisMonday.setHours(0,0,0,0);
  const sunday = new Date(thisMonday);
  sunday.setDate(thisMonday.getDate() + 6);
  const fmt = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  return `${fmt(thisMonday)} ‚Äì ${fmt(sunday)}`;
}

function changeWeek(dir) {
  if (!APP._currentPhilPlan) return;
  APP._currentWeek = Math.max(1, Math.min(16, (APP._currentWeek || 1) + dir));
  const phases = ['Base Building','Base Building','Base Building','Base Building','Base Building',
    'Lactate Dev','Lactate Dev','Lactate Dev','Lactate Dev','Lactate Dev','Lactate Dev',
    'Race Specific','Race Specific','Race Specific','Taper','Taper'];
  document.getElementById('plan-week-title').textContent = `${getWeekDateLabel(APP._currentWeek)} ‚Äî ${phases[APP._currentWeek-1]}`;
  // Re-render with slight variation per week
  const weekScale = APP._currentWeek <= 5 ? 0.85 + APP._currentWeek*0.03 :
                    APP._currentWeek <= 11 ? 1.0 + (APP._currentWeek-5)*0.02 :
                    APP._currentWeek <= 14 ? 1.1 : 0.75;
  const grid = document.getElementById('week-grid');
  grid.innerHTML = '';
  let total = 0;
  APP._currentPhilPlan.forEach(day => {
    const baseMi = parseFloat(day.dist) || 0;
    const scaledMi = baseMi ? Math.round(baseMi * weekScale) : 0;
    const dist = scaledMi ? scaledMi + ' mi' : '';
    total += scaledMi;
    const d = document.createElement('div');
    d.className = 'day-block';
    d.innerHTML = `<div class="day-name">${day.day}</div><div class="day-type ${day.type}">${day.type}</div><div class="day-workout">${day.name}</div>${dist?`<div class="day-dist">${dist}</div>`:''}`;
    grid.appendChild(d);
  });
  document.getElementById('week-total').textContent = total + ' mi';
}

function setPlanView(view) {
  const weekly = document.getElementById('plan-view-weekly');
  const monthly = document.getElementById('plan-view-monthly');
  const wBtn = document.getElementById('view-weekly-btn');
  const mBtn = document.getElementById('view-monthly-btn');
  if (view === 'weekly') {
    weekly.style.display = 'block';
    monthly.style.display = 'none';
    wBtn.style.background = 'var(--accent)'; wBtn.style.color = '#000'; wBtn.style.borderColor = 'var(--accent)';
    mBtn.style.background = 'transparent'; mBtn.style.color = 'var(--muted)'; mBtn.style.borderColor = 'var(--border)';
  } else {
    weekly.style.display = 'none';
    monthly.style.display = 'block';
    wBtn.style.background = 'transparent'; wBtn.style.color = 'var(--muted)'; wBtn.style.borderColor = 'var(--border)';
    mBtn.style.background = 'var(--accent)'; mBtn.style.color = '#000'; mBtn.style.borderColor = 'var(--accent)';
    renderMonthlyPlan();
  }
}

function renderMonthlyPlan() {
  if (!APP._currentPhilPlan) { generatePlan(); }
  const plan = APP._currentPhilPlan;
  const phases = [
    {weeks:[1,2,3,4], label:'Base Building', color:'var(--accent)'},
    {weeks:[5,6,7,8], label:'Aerobic Development', color:'var(--blue)'},
    {weeks:[9,10,11,12], label:'Lactate & Threshold', color:'var(--accent2)'},
    {weeks:[13,14,15,16], label:'Race Specific & Taper', color:'var(--orange)'},
  ];
  const grid = document.getElementById('monthly-grid');
  grid.innerHTML = '';
  phases.forEach(phase => {
    const phaseEl = document.createElement('div');
    phaseEl.className = 'card';
    phaseEl.style.marginBottom = '12px';
    let weeksHtml = phase.weeks.map(wk => {
      const scale = wk <= 5 ? 0.85 + wk*0.03 : wk <= 11 ? 1.0 + (wk-5)*0.02 : wk <= 14 ? 1.1 : 0.75;
      const daysHtml = plan.map(day => {
        const baseMi = parseFloat(day.dist) || 0;
        const mi = baseMi ? Math.round(baseMi * scale) : 0;
        return `<div style="flex:1;min-width:0;text-align:center;padding:4px 2px;">
          <div style="font-family:IBM Plex Mono,monospace;font-size:7px;color:var(--muted);margin-bottom:2px;">${day.day}</div>
          <div style="font-size:8px;font-weight:500;color:${day.type==='rest'?'var(--muted)':day.type==='long'?'var(--accent)':day.type==='tempo'?'var(--accent2)':day.type==='vo2'?'var(--blue)':'var(--text)'};">${mi ? mi+'mi' : '‚Äî'}</div>
          <div style="font-size:7px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${day.name.split(' ').slice(0,2).join(' ')}</div>
        </div>`;
      }).join('');
      const total = plan.reduce((s,d) => s + (parseFloat(d.dist)||0)*scale, 0);
      return `<div style="margin-bottom:8px;">
        <div style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);margin-bottom:4px;display:flex;justify-content:space-between;">
          <span>${getWeekDateLabel(wk)}</span><span style="color:var(--accent);">${Math.round(total)} mi</span>
        </div>
        <div style="display:flex;gap:2px;">${daysHtml}</div>
      </div>`;
    }).join('');
    phaseEl.innerHTML = `
      <div class="card-title" style="border-left:3px solid ${phase.color};padding-left:10px;">${phase.label}</div>
      ${weeksHtml}`;
    grid.appendChild(phaseEl);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 3: AI COACH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Build persona dropdown from KB
function buildPersonaDropdown() {
  // Now handled by settings dropdown
  loadSettings().catch(() => {});
  updateNavCountdown();
}

// ‚îÄ‚îÄ SETTINGS DROPDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let settingsSaveTimer = null;

function toggleSettings() {
  document.getElementById('settings-dropdown').classList.toggle('open');
}

document.addEventListener('click', e => {
  if (!e.target.closest('.settings-wrap')) {
    document.getElementById('settings-dropdown')?.classList.remove('open');
  }
});

async function loadSettings() {
  const saved = localStorage.getItem('runiq_settings');
  if (saved) {
    try {
      const s = JSON.parse(saved);
      if (s.raceName) document.getElementById('s-race-name').value = s.raceName;
      if (s.raceDate) document.getElementById('s-race-date').value = s.raceDate;
      if (s.raceDist) document.getElementById('s-race-dist').value = s.raceDist;
      if (s.goalTime) { const el = document.getElementById('s-goal-time'); if (el) el.value = s.goalTime; }
      if (s.persona) APP.currentPersona = s.persona;
      updateCountdown(s.raceDate);
    } catch(e) {}
  }

  // Backfill from athlete memory if local settings are missing/empty.
  if (APP.athlete && APP.athlete.id) {
    const raceNameEl = document.getElementById('s-race-name');
    const raceDateEl = document.getElementById('s-race-date');
    const raceDistEl = document.getElementById('s-race-dist');
    const goalTimeEl = document.getElementById('s-goal-time');
    const hasLocalGoal = !!(raceNameEl?.value || raceDateEl?.value || raceDistEl?.value || goalTimeEl?.value);
    if (!hasLocalGoal) {
      try {
        const res = await fetch(`/api/athlete-memory?athleteId=${APP.athlete.id}`);
        if (res.ok) {
          const mem = await res.json();
          if (mem?.targetRace && raceNameEl) raceNameEl.value = mem.targetRace;
          if (mem?.targetDate && raceDateEl) raceDateEl.value = mem.targetDate;
          if (mem?.raceDist && raceDistEl) raceDistEl.value = mem.raceDist;
          if (mem?.goalTime && goalTimeEl) goalTimeEl.value = mem.goalTime;
          if (mem?.targetDate) updateCountdown(mem.targetDate);
          if (mem && (mem.targetRace || mem.targetDate || mem.raceDist || mem.goalTime)) saveSettings();
        }
      } catch(e) {}
    }
  }
  renderSettingsPersonas();
}

function debounceSaveSettings() {
  clearTimeout(settingsSaveTimer);
  settingsSaveTimer = setTimeout(saveSettings, 600);
  updateCountdown(document.getElementById('s-race-date').value);
}

function saveSettings() {
  const s = {
    raceName: document.getElementById('s-race-name').value,
    raceDate: document.getElementById('s-race-date').value,
    raceDist: document.getElementById('s-race-dist').value,
    goalTime: document.getElementById('s-goal-time')?.value || '',
    persona: APP.currentPersona
  };
  localStorage.setItem('runiq_settings', JSON.stringify(s));
  // Also save to athlete memory for AI injection
  if (APP.athlete && (s.raceName || s.raceDate || s.raceDist || s.goalTime)) {
    fetch('/api/athlete-memory', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        athleteId: APP.athlete.id, action: 'set_goal',
        data: { goal: `${s.raceDist || 'marathon'} ‚Äî ${s.raceName}`, targetRace: s.raceName, targetDate: s.raceDate, goalTime: s.goalTime, raceDist: s.raceDist }
      })
    }).catch(() => {});
  }
}

function updateCountdown(raceDate) {
  const el = document.getElementById('s-countdown');
  if (!raceDate || !el) return;
  const weeks = Math.round((new Date(raceDate) - Date.now()) / (7 * 86400000));
  if (weeks > 0) {
    el.textContent = `${weeks} weeks to race`;
  } else if (weeks === 0) {
    el.textContent = 'Race week!';
  } else {
    el.textContent = 'Race passed';
    el.style.color = 'var(--muted)';
  }
}

function renderSettingsPersonas() {
  const KB = typeof RUNIQ_KB !== 'undefined' ? RUNIQ_KB : null;
  const personas = KB ? KB.personas : {};
  const container = document.getElementById('settings-persona-list');
  if (!container) return;
  container.innerHTML = '';
  Object.values(personas).forEach(p => {
    const el = document.createElement('div');
    el.className = `settings-persona-opt${APP.currentPersona === p.id ? ' active' : ''}`;
    el.innerHTML = `<span style="font-size:16px;">${p.icon}</span><div><div style="font-size:12px;font-weight:500;">${p.name}</div><div style="font-size:11px;color:var(--muted);">${p.desc}</div></div>`;
    el.onclick = () => setPersona(p.id);
    container.appendChild(el);
  });
}

function setPersona(id, silent) {
  const KB = typeof RUNIQ_KB !== 'undefined' ? RUNIQ_KB : null;
  const personas = KB ? KB.personas : {};
  APP.currentPersona = id;
  renderSettingsPersonas();
  saveSettings();
  if (!silent) {
    document.getElementById('settings-dropdown').classList.remove('open');
    APP.chatHistory = [];
    document.getElementById('chat-messages').innerHTML = '';
    document.getElementById('suggested-replies').innerHTML = '';
    document.getElementById('analyze-bar').style.display = 'flex';
  }
}

// Race countdown in nav area
function updateNavCountdown() {
  const saved = localStorage.getItem('runiq_settings');
  if (!saved) return;
  const s = JSON.parse(saved);
  if (!s.raceDate || !s.raceName) return;
  const weeks = Math.round((new Date(s.raceDate) - Date.now()) / (7 * 86400000));
  if (weeks > 0 && weeks <= 26) {
    const versionEl = document.querySelector('[style*="v0."]') || document.querySelector('.nav-tabs + div');
    // Show countdown near nav
    let countEl = document.getElementById('nav-countdown');
    if (!countEl) {
      countEl = document.createElement('div');
      countEl.id = 'nav-countdown';
      countEl.style.cssText = "font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--accent2);letter-spacing:1px;margin-left:8px;";
      const nav = document.querySelector('nav');
      const navRight = document.querySelector('.nav-right');
      if (nav && navRight) nav.insertBefore(countEl, navRight);
    }
    countEl.textContent = `${weeks}wk to ${s.raceName}`;
  }
}

// ‚îÄ‚îÄ WORKOUT HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildWorkoutHistory() {
  const container = document.getElementById('workout-history');
  container.innerHTML = '';
  const recent = APP.activities.slice(0, 30);
  if (!recent.length) {
    container.innerHTML = '<div style="padding:16px;font-size:12px;color:var(--muted);">No activities loaded.</div>';
    return;
  }
  recent.forEach((a, i) => {
    const mi = actToMi(a).toFixed(1);
    const pace = fmtPace(actPaceMi(a));
    const daysAgo = Math.floor((Date.now() - new Date(a.start_date)) / 86400000);
    const dateLabel = daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo}d ago`;
    const el = document.createElement('div');
    el.className = `history-item${i===0?' selected':''}`;
    el.setAttribute('data-id', a.id);
    el.onclick = () => selectWorkout(a, el);
    el.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="hi-date">${dateLabel}</div>
        <div style="display:flex;align-items:center;gap:5px;">
          ${i===0?'<div style="width:6px;height:6px;border-radius:50%;background:var(--accent);"></div>':''}
          <a href="https://www.strava.com/activities/${a.id}" target="_blank" onclick="event.stopPropagation()" style="font-family:IBM Plex Mono,monospace;font-size:8px;color:var(--muted);text-decoration:none;padding:1px 5px;border:1px solid var(--border);border-radius:2px;transition:all .15s;" onmouseover="this.style.color='#fc4c02';this.style.borderColor='#fc4c02'" onmouseout="this.style.color='var(--muted)';this.style.borderColor='var(--border)'">‚Üó</a>
        </div>
      </div>
      <div class="hi-name">${a.name}</div>
      <div class="hi-stats">
        <div class="hi-stat"><span>${mi} mi</span></div>
        <div class="hi-stat"><span>${pace}/mi</span></div>
      </div>`;
    container.appendChild(el);
  });
  // Auto-select most recent ‚Äî fetch detail so laps are available
  if (recent.length) {
    const first = recent[0];
    const firstEl = container.querySelector('.history-item');
    if (firstEl) selectWorkout(first, firstEl);
  }
}

async function selectWorkout(activity, el) {
  if (APP._chatRunning) return;
  const selectSeq = ++APP._workoutSelectSeq;
  document.querySelectorAll('.history-item').forEach(i => i.classList.remove('selected'));
  if (el) el.classList.add('selected');
  const previousWorkoutId = APP.currentWorkout ? APP.currentWorkout.id : null;

  // Fetch detailed activity to get laps (list endpoint doesn't include them)
  let detailed = activity;
  if (!APP.demoMode && !activity.laps) {
    try {
      detailed = await stravaGet(`/activities/${activity.id}`);
      // Cache it back into activities array
      const idx = APP.activities.findIndex(a => a.id === activity.id);
      if (idx >= 0) APP.activities[idx] = detailed;
    } catch(e) {
      detailed = activity; // fallback
    }
  }
  if (selectSeq !== APP._workoutSelectSeq) return;

  APP.currentWorkout = detailed;
  APP._analyzed = !!APP.analyzedWorkouts[detailed.id];
  renderWorkoutBanner(detailed);
  // Auto-grade against prescription
  const gradeResult = checkRxGrade(detailed);
  if (gradeResult) {
    // Show grade badge in banner
    let gradeBadge = document.getElementById('rx-grade-badge');
    if (!gradeBadge) {
      gradeBadge = document.createElement('div');
      gradeBadge.id = 'rx-grade-badge';
      gradeBadge.style.cssText = "font-family:IBM Plex Mono,monospace;font-size:10px;padding:2px 8px;border-radius:10px;margin-left:8px;";
      const titleEl = document.getElementById('banner-title');
      if (titleEl && titleEl.parentNode) titleEl.parentNode.appendChild(gradeBadge);
    }
    const letterClass = gradeResult.letter;
    const colors = {A:'rgba(16,185,129,.1);color:#10b981',B:'rgba(37,99,235,.1);color:var(--accent)',C:'rgba(249,115,22,.08);color:var(--accent2)',D:'rgba(239,68,68,.08);color:#ef4444',F:'rgba(239,68,68,.08);color:#ef4444'};
    gradeBadge.style.cssText += `background:${colors[letterClass] || colors.F};border:1px solid currentColor;`;
    gradeBadge.textContent = `Rx: ${gradeResult.letter} (${gradeResult.grade}%)`;
  } else {
    const existing = document.getElementById('rx-grade-badge');
    if (existing) existing.remove();
  }
  document.getElementById('ping-btn').className = 'ping-btn';
  document.getElementById('suggested-replies').innerHTML = '';
  if (!APP.chatInitialized) {
    APP.chatHistory = [];
    await loadChatHistory(null, selectSeq);
    APP.chatInitialized = true;
  } else if (previousWorkoutId !== detailed.id) {
    addWorkoutSeparator(detailed);
  }
  if (selectSeq !== APP._workoutSelectSeq || !APP.currentWorkout || APP.currentWorkout.id !== detailed.id) return;
  document.getElementById('analyze-bar').style.display = 'flex';
  updateAnalyzeButton();
  if (APP_RX) renderRxSidebar(APP_RX);
  renderWeeklySummary();
}

function renderWorkoutBanner(a) {
  const mi = actToMi(a).toFixed(1);
  const pace = fmtPace(actPaceMi(a));
  const hr = a.average_heartrate ? Math.round(a.average_heartrate) + ' bpm' : '‚Äî';
  const hrMax = a.max_heartrate ? Math.round(a.max_heartrate) + ' bpm' : '‚Äî';

  document.getElementById('banner-title').textContent = a.name;
  const stravaLink = document.getElementById('strava-banner-link');
  if (stravaLink && a.id) {
    stravaLink.href = `https://www.strava.com/activities/${a.id}`;
    stravaLink.style.display = 'inline';
  }
  document.getElementById('banner-stats').innerHTML = `
    <div class="wbs">Distance: <span>${mi} mi</span></div>
    <div class="wbs">Avg Pace: <span>${pace}/mi</span></div>
    <div class="wbs">Avg HR: <span>${hr}</span></div>
    <div class="wbs">Max HR: <span>${hrMax}</span></div>
    ${a.average_cadence ? `<div class="wbs">Cadence: <span>${Math.round(a.average_cadence)} spm</span></div>` : ''}
  `;

  // Pace breakdown (laps)
  renderPaceBreakdown(a);

  // HR chart
  renderHRChart(a);

  // AI handoff
  document.getElementById('ai-handoff').textContent =
    `${a.name} ¬∑ ${mi}mi ¬∑ ${pace}/mi avg ¬∑ HR ${hr}. Review pending coach.`;
}

function collapseSplits() {
  const pb = document.getElementById('pace-breakdown');
  const toggle = document.getElementById('splits-toggle');
  if (pb && pb.classList.contains('visible')) {
    pb.classList.add('collapsed');
    document.getElementById('splits-toggle-icon').textContent = '‚ñº';
    document.getElementById('splits-toggle-label').textContent = 'SHOW SPLITS';
  }
}

function toggleSplits() {
  const pb = document.getElementById('pace-breakdown');
  const icon = document.getElementById('splits-toggle-icon');
  const label = document.getElementById('splits-toggle-label');
  if (!pb) return;
  if (pb.classList.contains('collapsed')) {
    pb.classList.remove('collapsed');
    icon.textContent = '‚ñ≤';
    label.textContent = 'HIDE SPLITS';
  } else {
    pb.classList.add('collapsed');
    icon.textContent = '‚ñº';
    label.textContent = 'SHOW SPLITS';
  }
}

function renderPaceBreakdown(a) {
  const wrap = document.getElementById('pace-breakdown');
  const laps = (a.laps || []).filter(l => l.distance && l.distance > 200);
  if (!laps.length) { wrap.classList.remove('visible'); return; }
  wrap.classList.add('visible');
  wrap.classList.remove('collapsed');
  const toggle = document.getElementById('splits-toggle');
  if (toggle) { toggle.style.display = 'flex'; document.getElementById('splits-toggle-icon').textContent = '‚ñ≤'; document.getElementById('splits-toggle-label').textContent = 'HIDE SPLITS'; }
  const avgPace = actPaceMi(a);
  let rows = '';
  laps.forEach((lap, i) => {
    const lapMi = lap.distance / 1609.34;
    const lapPace = lap.moving_time ? lap.moving_time / lapMi : lap.elapsed_time / lapMi;
    const diff = lapPace - avgPace;
    const isFast = diff < -10;
    const isSlow = diff > 10;
    const cls = isFast ? 'fast' : isSlow ? 'slow' : '';
    const hr = lap.average_heartrate ? Math.round(lap.average_heartrate) + ' bpm' : '‚Äî';
    const elev = lap.total_elevation_gain !== undefined ? (lap.total_elevation_gain > 0 ? '+' : '') + Math.round(lap.total_elevation_gain) + ' ft' : '‚Äî';
    rows += `<tr>
      <td>${i+1}</td>
      <td class="pb-split ${cls}">${fmtPace(lapPace)}<span style="font-size:8px;color:var(--muted);"> /mi</span></td>
      <td style="color:var(--muted);">${hr}</td>
      <td style="color:var(--muted);">${elev}</td>
    </tr>`;
  });
  wrap.innerHTML = `<table class="pb-splits-table">
    <thead><tr><th>MI</th><th>PACE</th><th>HR</th><th>ELEV</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function renderHRChart(a) {
  const wrap = document.getElementById('hr-chart-wrap');
  const canvas = document.getElementById('hr-canvas');

  // Build HR stream from laps
  const hrStream = a._hrStream || (a.laps && a.laps.length ? a.laps.map(l => l.average_heartrate).filter(Boolean) : null);
  // Build pace stream from laps (seconds per mile)
  const paceStream = a.laps && a.laps.length ? a.laps.map(l => l.distance > 0 ? l.elapsed_time / (l.distance / 1609.34) : null).filter(Boolean) : null;

  if (!hrStream || !hrStream.length) { wrap.classList.remove('visible'); return; }
  wrap.classList.add('visible');
  document.getElementById('hr-chart-label').textContent = a.name;

  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 500;
  const H = 80;
  canvas.width = W;
  canvas.height = H;
  ctx.clearRect(0, 0, W, H);

  // HR scale
  const minHR = Math.min(...hrStream) - 5;
  const maxHR = Math.max(...hrStream) + 5;
  const hrY = hr => H - ((hr - minHR) / (maxHR - minHR)) * H;

  // HR fill
  ctx.beginPath();
  hrStream.forEach((hr, i) => {
    const x = (i / (hrStream.length - 1)) * W;
    i === 0 ? ctx.moveTo(x, hrY(hr)) : ctx.lineTo(x, hrY(hr));
  });
  ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, 'rgba(232,255,71,.2)');
  grad.addColorStop(1, 'rgba(232,255,71,.02)');
  ctx.fillStyle = grad; ctx.fill();

  // HR line
  ctx.beginPath();
  ctx.lineWidth = 1.5;
  hrStream.forEach((hr, i) => {
    const x = (i / (hrStream.length - 1)) * W;
    i === 0 ? ctx.moveTo(x, hrY(hr)) : ctx.lineTo(x, hrY(hr));
  });
  ctx.strokeStyle = 'rgba(232,255,71,.8)'; ctx.stroke();

  // Pace overlay (orange line)
  if (paceStream && paceStream.length > 1) {
    const minPace = Math.min(...paceStream) - 10;
    const maxPace = Math.max(...paceStream) + 10;
    const paceY = p => H - ((p - minPace) / (maxPace - minPace)) * H * 0.85; // scale slightly inside
    ctx.beginPath();
    ctx.lineWidth = 1.5;
    ctx.setLineDash([4, 3]);
    paceStream.forEach((p, i) => {
      const x = (i / (paceStream.length - 1)) * W;
      i === 0 ? ctx.moveTo(x, paceY(p)) : ctx.lineTo(x, paceY(p));
    });
    ctx.strokeStyle = 'rgba(255,159,67,.7)'; ctx.stroke();
    ctx.setLineDash([]);
  }

  // Hover tooltip
  const tooltip = document.getElementById('chart-tooltip');
  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (W / rect.width);
    const idx = Math.round((mx / W) * (hrStream.length - 1));
    if (idx >= 0 && idx < hrStream.length) {
      const hr = hrStream[idx];
      const pace = paceStream && paceStream[Math.round(idx * (paceStream.length-1) / (hrStream.length-1))];
      const paceStr = pace ? fmtPace(pace) + '/mi' : '';
      tooltip.style.display = 'block';
      tooltip.style.position = 'fixed';
      tooltip.style.left = (e.clientX + 14) + 'px';
      tooltip.style.top = (e.clientY - 30) + 'px';
      tooltip.style.background = 'var(--s2)';
      tooltip.style.border = '1px solid var(--accent)';
      tooltip.style.borderRadius = '4px';
      tooltip.style.padding = '4px 8px';
      tooltip.style.fontSize = '10px';
      tooltip.style.pointerEvents = 'none';
      tooltip.style.zIndex = '999';
      tooltip.style.whiteSpace = 'nowrap';
      tooltip.textContent = `${hr}bpm${paceStr ? ' ¬∑ ' + paceStr : ''}`;

      // Draw crosshair
      ctx.clearRect(0, 0, W, H);
      // Redraw everything
      renderHRChartData(ctx, W, H, hrStream, paceStream, minHR, maxHR);
      ctx.beginPath();
      ctx.setLineDash([2, 3]);
      ctx.strokeStyle = 'rgba(255,255,255,.3)';
      ctx.lineWidth = 1;
      const x = (idx / (hrStream.length - 1)) * W;
      ctx.moveTo(x, 0); ctx.lineTo(x, H);
      ctx.stroke(); ctx.setLineDash([]);
    }
  };
  canvas.onmouseleave = () => { tooltip.style.display = 'none'; };

  // Store streams for hover redraw
  canvas._hrStream = hrStream;
  canvas._paceStream = paceStream;
  canvas._minHR = minHR; canvas._maxHR = maxHR;

  // Zones legend
  const avgHR = Math.round(hrStream.reduce((s,h) => s+h, 0) / hrStream.length);
  const maxHRVal = Math.round(Math.max(...hrStream));
  document.getElementById('hr-zones').innerHTML = `
    <span class="hz" style="background:rgba(61,158,255,.1);color:var(--blue);">Avg: ${avgHR}bpm</span>
    <span class="hz" style="background:rgba(255,77,46,.1);color:var(--accent2);">Peak: ${maxHRVal}bpm</span>
    <span class="hz" style="background:rgba(255,159,67,.1);color:#ff9f43;">‚Äî Pace</span>
    ${avgHR < 145 ? '<span class="hz" style="background:rgba(61,255,143,.1);color:var(--green);">‚úì Aerobic</span>' :
      avgHR < 165 ? '<span class="hz" style="background:rgba(232,255,71,.1);color:var(--accent);">Threshold</span>' :
      '<span class="hz" style="background:rgba(255,77,46,.1);color:var(--accent2);">VO2 Zone</span>'}
  `;
}

function renderHRChartData(ctx, W, H, hrStream, paceStream, minHR, maxHR) {
  ctx.clearRect(0, 0, W, H);
  const hrY = hr => H - ((hr - minHR) / (maxHR - minHR)) * H;
  ctx.beginPath();
  hrStream.forEach((hr, i) => {
    const x = (i / (hrStream.length - 1)) * W;
    i === 0 ? ctx.moveTo(x, hrY(hr)) : ctx.lineTo(x, hrY(hr));
  });
  ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, 'rgba(232,255,71,.2)');
  grad.addColorStop(1, 'rgba(232,255,71,.02)');
  ctx.fillStyle = grad; ctx.fill();
  ctx.beginPath(); ctx.lineWidth = 1.5;
  hrStream.forEach((hr, i) => {
    const x = (i / (hrStream.length - 1)) * W;
    i === 0 ? ctx.moveTo(x, hrY(hr)) : ctx.lineTo(x, hrY(hr));
  });
  ctx.strokeStyle = 'rgba(232,255,71,.8)'; ctx.stroke();
  if (paceStream && paceStream.length > 1) {
    const minP = Math.min(...paceStream) - 10;
    const maxP = Math.max(...paceStream) + 10;
    const paceY = p => H - ((p - minP) / (maxP - minP)) * H * 0.85;
    ctx.beginPath(); ctx.lineWidth = 1.5; ctx.setLineDash([4, 3]);
    paceStream.forEach((p, i) => {
      const x = (i / (paceStream.length - 1)) * W;
      i === 0 ? ctx.moveTo(x, paceY(p)) : ctx.lineTo(x, paceY(p));
    });
    ctx.strokeStyle = 'rgba(255,159,67,.7)'; ctx.stroke(); ctx.setLineDash([]);
  }
}

// ‚îÄ‚îÄ COACH CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initCoachChat() {
  if (!APP.currentWorkout) {
    if (APP.activities.length) {
      APP.currentWorkout = APP.activities[0];
    } else return;
  }
  renderWorkoutBanner(APP.currentWorkout);
  // Don't auto-fire ‚Äî user clicks Analyze
}

function addWorkoutSeparator(workout) {
  if (!workout || !workout.id) return;
  if (APP._lastChatWorkoutId === workout.id) return;
  APP._lastChatWorkoutId = workout.id;
  const container = document.getElementById('chat-messages');
  if (!container) return;
  const el = document.createElement('div');
  el.className = 'msg';
  el.style.cssText = 'align-self:center;opacity:.7;';
  el.innerHTML = `
    <div class="msg-bubble" style="font-family:IBM Plex Mono,monospace;font-size:10px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--s2);color:var(--muted);">
      WORKOUT: ${workout.name || 'Workout'}
    </div>`;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function updateAnalyzeButton() {
  const btn = document.getElementById('analyze-btn');
  if (!btn || !APP.currentWorkout) return;
  const analyzed = !!APP.analyzedWorkouts[APP.currentWorkout.id];
  btn.textContent = analyzed ? '‚ö° RE-ANALYZE' : '‚ö° ANALYZE';
}

async function analyzeWorkout(options = {}) {
  const { skipInitialAnalysis = false } = options;
  if (!APP.currentWorkout) return;
  if (APP._chatRunning) return;
  const workoutId = APP.currentWorkout.id;
  APP._chatRunning = true;
  APP._analyzed = true;
  APP.analyzedWorkouts[APP.currentWorkout.id] = true;
  updateAnalyzeButton();
  if (APP_RX) renderRxSidebar(APP_RX);
  document.getElementById('suggested-replies').innerHTML = '';
  if (skipInitialAnalysis) {
    APP._chatRunning = false;
    return;
  }
  showTyping();

  // Fetch detailed activity if laps not loaded yet
  if (!APP.currentWorkout.laps && APP.accessToken) {
    try {
      const detailed = await stravaGet(`/activities/${APP.currentWorkout.id}`);
      Object.assign(APP.currentWorkout, detailed);
      const idx = APP.activities.findIndex(x => x.id === APP.currentWorkout.id);
      if (idx >= 0) APP.activities[idx] = APP.currentWorkout;
      renderWorkoutBanner(APP.currentWorkout);
    } catch(e) { console.warn('Could not fetch lap detail:', e); }
  }

  const a = APP.currentWorkout;
  const mi = actToMi(a).toFixed(2);
  const pace = fmtPace(actPaceMi(a));
  const hr = a.average_heartrate ? Math.round(a.average_heartrate) : null;
  const laps = (a.laps || []).filter(l => l.distance > 100);
  const lapStr = laps.length ? laps.slice(0,8).map((l,i) => {
    const lapMi = l.distance / 1609.34;
    const lapPace = fmtPace(l.moving_time / lapMi);
    return `Mile ${i+1}: ${lapPace}`;
  }).join(', ') : 'No lap data';
  const daysAgo = Math.floor((Date.now() - new Date(a.start_date)) / 86400000);

  const workoutDetail = `${a.name} ‚Äî ${mi} miles @ ${pace}/mi avg${hr ? `, HR avg ${hr}bpm` : ''}${a.max_heartrate ? `, peak ${a.max_heartrate}bpm` : ''}${a.average_cadence ? `, cadence ${Math.round(a.average_cadence)}spm` : ''}. ${daysAgo === 0 ? 'Just completed.' : `${daysAgo} day(s) ago.`} Splits: ${lapStr}.`;

  const recentContext = APP.activities.slice(0,5).map(act =>
    `${Math.floor((Date.now()-new Date(act.start_date))/86400000)}d ago: ${act.name} ‚Äî ${actToMi(act).toFixed(1)}mi @ ${fmtPace(actPaceMi(act))}/mi`
  ).join('\n');

  // Weekly pattern analysis
  const now = Date.now();
  const dow = (new Date().getDay() + 6) % 7; // Mon=0, Sun=6
  const weekStartMs = (() => { const d = new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate() - dow); return d.getTime(); })();
  const thisWeekActs = APP.activities.filter(x => new Date(x.start_date).getTime() >= weekStartMs);
  const lastWeekActs = APP.activities.filter(x => {
    const t = new Date(x.start_date).getTime();
    return t >= weekStartMs - 7*86400000 && t < weekStartMs;
  });
  const thisWeekMi = thisWeekActs.reduce((s,x) => s + actToMi(x), 0).toFixed(1);
  const lastWeekMi = lastWeekActs.reduce((s,x) => s + actToMi(x), 0).toFixed(1);
  const daysSinceLastRun = APP.activities.length > 1
    ? Math.floor((now - new Date(APP.activities[1].start_date).getTime()) / 86400000)
    : null;
  const daysIntoWeek = dow + 1; // 1=Mon, 7=Sun
  const expectedRunsByNow = Math.round(daysIntoWeek * 5 / 7); // assume ~5 runs/week
  const weeklyFlag = thisWeekActs.length < expectedRunsByNow - 1
    ? `LOW VOLUME ALERT: Only ${thisWeekActs.length} run(s) this week (${daysIntoWeek} days in). Last week was ${lastWeekMi} miles.`
    : null;
  const gapFlag = daysSinceLastRun !== null && daysSinceLastRun >= 3
    ? `GAP ALERT: ${daysSinceLastRun} days since previous run.`
    : null;

  const weeklyContext = [
    `THIS WEEK (${daysIntoWeek} days in): ${thisWeekActs.length} run(s), ${thisWeekMi} miles`,
    `LAST WEEK: ${lastWeekActs.length} run(s), ${lastWeekMi} miles`,
    daysSinceLastRun !== null ? `DAYS SINCE PREV RUN: ${daysSinceLastRun}` : null,
    weeklyFlag,
    gapFlag
  ].filter(Boolean).join('\n');

  const KB = typeof RUNIQ_KB !== 'undefined' ? RUNIQ_KB : null;
  const personas = KB ? KB.personas : {};
  const p = personas[APP.currentPersona] || { prompt: 'You are a supportive running coach. Keep responses under 60 words. Be conversational, not a report.' };

  const systemPrompt = `${p.prompt}

WORKOUT JUST COMPLETED:
${workoutDetail}

WEEKLY TRAINING PATTERN:
${weeklyContext}

RECENT TRAINING CONTEXT (last 5 activities):
${recentContext}

Give a SHORT post-workout reaction ‚Äî 2-3 sentences max. Reference the actual numbers. If the weekly volume is low for this point in the week, or there's been a multi-day gap, acknowledge it directly ‚Äî ask what's going on, if they're sick, tired, busy. Don't ignore red flags. No exclamation points. No fluff. End with ONE question.

IMPORTANT ‚Äî Weather/conditions inference rules: NEVER speculate about humidity, heat, or environmental conditions unless the actual temperature or weather data is present in the activity data. If the run name references a city or location, do not assume weather conditions based on season or month ‚Äî conditions vary widely. Only comment on conditions if concrete data supports it.`;

  try {
    const res = await fetch('/api/claude', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':ANTHROPIC_API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-client-side-api-keys':'true'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system: systemPrompt,
        messages:[{role:'user', content:'Analyze my workout.'}],
        athleteId: APP.athlete ? APP.athlete.id : null,
        contextDate: a?.start_date || new Date().toISOString()
      })
    });
    const data = await res.json();
    const text = data.content?.[0]?.text || 'Error getting response.';
    if (!APP.currentWorkout || APP.currentWorkout.id !== workoutId) {
      APP._chatRunning = false;
      return;
    }
    hideTyping();
    addMsg('ai', text);
    APP.chatHistory.push({role:'user', content:'Analyze my workout.'});
    APP.chatHistory.push({role:'assistant', content:text});
    appendTimelineMessage('athlete', 'Analyze my workout.');
    appendTimelineMessage('ai', text);
    setSuggestedReplies(getSuggestions());
    persistChat();
    // Auto-save workout summary to athlete memory
    if (APP.athlete && APP.currentWorkout) {
      autoSaveWorkoutSummary(APP.currentWorkout, text);
    }
  } catch(e) {
    if (!APP.currentWorkout || APP.currentWorkout.id !== workoutId) {
      APP._chatRunning = false;
      return;
    }
    hideTyping();
    addMsg('ai', `Great work on that ${a.name}! ${mi} miles at ${pace}/mi. ${hr ? `Your HR averaged ${hr}bpm. ` : ''}How did it feel?`);
    APP.chatHistory.push({role:'user', content:'Analyze my workout.'});
    APP.chatHistory.push({role:'assistant', content:`Great work on that ${a.name}! ${mi} miles at ${pace}/mi. ${hr ? `Your HR averaged ${hr}bpm. ` : ''}How did it feel?`});
    appendTimelineMessage('athlete', 'Analyze my workout.');
    appendTimelineMessage('ai', `Great work on that ${a.name}! ${mi} miles at ${pace}/mi. ${hr ? `Your HR averaged ${hr}bpm. ` : ''}How did it feel?`);
    persistChat();
    APP._chatRunning = false;
  }

  // Weekly summary panel
  renderWeeklySummary();
  APP._chatRunning = false;
}

function getSuggestions() {
  const s = {
    drillsergeant: ['Legs felt dead', 'Hit every split', 'Struggled at the end', 'What do I fix next?'],
    neighborbob:   ['Felt pretty good!', 'Harder than expected', 'Proud of this one', 'What should I focus on?'],
    professor:     ['My HR was higher than expected', 'Tell me about lactate threshold', 'Was my cadence optimal?', 'What zones was I in?'],
    hypeman:       ['I crushed it!', 'Really tough but worth it', 'Feeling motivated', 'How does this build my goal?'],
    elitepacer:    ['Splits were inconsistent', 'Felt like threshold the whole time', 'Ready for harder work', 'Break down the physiology'],
  };
  return s[APP.currentPersona] || s.neighborbob;
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  if (!APP._analyzed && !APP._chatRunning) {
    await analyzeWorkout({ skipInitialAnalysis: true });
  }

  input.value = ''; input.style.height = 'auto';
  document.getElementById('suggested-replies').innerHTML = '';
  addMsg('athlete', text);
  APP.chatHistory.push({role:'user', content:text});
  appendTimelineMessage('athlete', text);
  persistChat();
  showTyping();

  const a = APP.currentWorkout;
  const workoutId = a && a.id;
  if (!workoutId) {
    hideTyping();
    return;
  }
  const KB = typeof RUNIQ_KB !== 'undefined' ? RUNIQ_KB : null;
  const personas = KB ? KB.personas : {};
  const p = personas[APP.currentPersona] || { prompt: 'You are a supportive running coach. Keep responses under 60 words. Be conversational, not a report.' };
  const smallTalk = isSmallTalkMessage(text);

  if (!smallTalk) {
    const planHandled = await tryPlanUpdateFromChat(text);
    if (planHandled && planHandled.reply) {
      hideTyping();
      addMsg('ai', planHandled.reply);
      APP.chatHistory.push({role:'assistant', content:planHandled.reply});
      appendTimelineMessage('ai', planHandled.reply);
      setSuggestedReplies([]);
      persistChat();
      return;
    }
  }

  const thisWeekActsSend = APP.activities.filter(x => new Date(x.start_date).getTime() >= (() => { const d = new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate() - (new Date().getDay()+6)%7); return d.getTime(); })());
  const rxContext = buildRxSummaryShort(APP_RX);
  const systemPrompt = smallTalk
    ? `You are an AI running coach talking directly to the athlete.
The athlete sent: "${text}"
Respond as a normal human coach in 1 short sentence.
Do not analyze workout metrics unless the athlete explicitly asks for analysis.
Keep it friendly and athlete-facing ("you").`
    : `${p.prompt}

PRIORITY RULES:
- You are speaking directly to the athlete.
- Do not force workout analysis for greetings or social messages.
- Only give detailed workout analysis when the athlete asks for it.

WORKOUT CONTEXT: ${a.name} ‚Äî ${actToMi(a).toFixed(1)} miles @ ${fmtPace(actPaceMi(a))}/mi${a.average_heartrate ? `, HR ${Math.round(a.average_heartrate)}bpm avg` : ''}.
THIS WEEK: ${thisWeekActsSend.length} run(s), ${thisWeekActsSend.reduce((s,x)=>s+actToMi(x),0).toFixed(1)} miles.
RECENT TRAINING: ${APP.activities.slice(0,3).map(act => `${act.name} ${actToMi(act).toFixed(1)}mi`).join(', ')}.
PRESCRIBED PLAN: ${rxContext}`;

  try {
    const res = await fetch('/api/claude', {
      method:'POST', headers:{'Content-Type':'application/json','x-api-key':ANTHROPIC_API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-client-side-api-keys':'true'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514', max_tokens:1000,
        system: systemPrompt,
        messages: APP.chatHistory,
        athleteId: APP.athlete ? APP.athlete.id : null,
        contextDate: a?.start_date || new Date().toISOString()
      })
    });
    const data = await res.json();
    const reply = data.content?.[0]?.text || 'Error.';
    if (!APP.currentWorkout || APP.currentWorkout.id !== workoutId) {
      hideTyping();
      return;
    }
    hideTyping();
    addMsg('ai', reply);
    APP.chatHistory.push({role:'assistant', content:reply});
    appendTimelineMessage('ai', reply);
    setSuggestedReplies([]);
    persistChat();
  } catch(e) {
    hideTyping();
    addMsg('ai', 'Connection issue ‚Äî try again.');
  }
}

function shouldCheckPlanChange(text) {
  const t = (text || '').toLowerCase();
  return /(change|switch|swap|move|reschedule|can't run|cannot run|can'?t make|skip|miss|tomorrow|next day|race|racing|taper|more volume|less volume|too much|too little|increase mileage|decrease mileage|need more|need less)/.test(t);
}

function showToast(msg, timeout = 2600) {
  const el = document.getElementById('toast');
  if (!el || !msg) return;
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(() => {
    el.classList.remove('show');
  }, timeout);
}

function getDayKeyFromDate(d) {
  return ['sun','mon','tue','wed','thu','fri','sat'][d.getDay()];
}

function buildRecentRunsSummary(limit = 8) {
  const acts = (APP.activities || []).slice(0, limit);
  return acts.map(a => {
    const date = new Date(a.start_date).toLocaleDateString('en-US', { month:'short', day:'numeric' });
    const mi = actToMi(a).toFixed(1);
    const pace = fmtPace(actPaceMi(a));
    return `${date} ${a.name} ${mi}mi @ ${pace}/mi`;
  }).join(' | ');
}

function buildRxSummaryShort(rx) {
  if (!rx || !rx.days) return 'No prescription loaded.';
  const dayOrder = ['mon','tue','wed','thu','fri','sat','sun'];
  const lines = dayOrder.map(k => {
    const d = rx.days[k];
    if (!d) return null;
    const label = d.label || (d.type === 'rest' ? 'Rest' : 'Workout');
    const mi = d.totalDist ? `${d.totalDist}mi` : '';
    const status = d.completed ? 'completed' : 'upcoming';
    return `${k.toUpperCase()}: ${label}${mi ? ' ¬∑ ' + mi : ''} (${status})`;
  }).filter(Boolean);
  return lines.join(' | ');
}

function normalizePlanFromAI(planRaw) {
  if (!planRaw) return null;
  if (planRaw.days) return planRaw;
  const hasDayKeys = ['mon','tue','wed','thu','fri','sat','sun'].some(k => planRaw[k]);
  if (hasDayKeys) return { days: planRaw };
  return null;
}

function computeTotalMilesFromDays(days) {
  if (!days) return 0;
  return Math.round(Object.values(days).reduce((s,d) => s + (d?.totalDist || 0), 0) * 10) / 10;
}

function normalizeDayForCompare(day) {
  if (!day) return null;
  const d = { ...day };
  delete d.completed;
  delete d.completedAt;
  delete d.grade;
  delete d.gradeBreakdown;
  delete d.letter;
  delete d.activityId;
  return d;
}

function getChangedRxDays(prevDays, nextDays) {
  const order = ['mon','tue','wed','thu','fri','sat','sun'];
  const changed = [];
  order.forEach(k => {
    const a = normalizeDayForCompare(prevDays?.[k] || null);
    const b = normalizeDayForCompare(nextDays?.[k] || null);
    if (JSON.stringify(a) !== JSON.stringify(b)) changed.push(k);
  });
  return changed;
}

function formatDayList(keys) {
  const names = {mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday',sun:'Sunday'};
  if (!keys || !keys.length) return 'your week';
  if (keys.length === 1) return names[keys[0]] || keys[0];
  if (keys.length === 2) return `${names[keys[0]]}, ${names[keys[1]]}`;
  return `${names[keys[0]]}, ${names[keys[1]]} +${keys.length - 2} more`;
}

function formatDaySummary(dayKey, days) {
  const names = {mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday',sun:'Sunday'};
  const d = days?.[dayKey];
  if (!d) return names[dayKey] || dayKey;
  const label = d.label || (d.type === 'rest' ? 'Rest' : 'Workout');
  const dist = d.totalDist ? `${d.totalDist}mi` : '';
  return `${names[dayKey] || dayKey}: ${label}${dist ? ' ¬∑ ' + dist : ''}`;
}

async function tryPlanUpdateFromChat(text) {
  if (!APP_RX || !APP_RX.days || APP.demoMode || !APP.athlete) return null;
  if (!shouldCheckPlanChange(text)) return null;

  const today = new Date();
  const todayKey = getDayKeyFromDate(today);
  const recentRuns = buildRecentRunsSummary(10);
  const prevDays = JSON.parse(JSON.stringify(APP_RX.days || {}));
  const planJson = JSON.stringify(APP_RX.days || {}, null, 2);

  const systemPrompt = `You are an AI running coach assistant. Decide if the athlete's message requires changing the prescribed plan. Use today's date and the plan. If a change is needed, update only upcoming days (never edit completed days). Keep the schema EXACT.

TODAY: ${today.toISOString()} (${todayKey})
PRESCRIBED PLAN JSON (days only): ${planJson}
RECENT RUNS: ${recentRuns || 'No recent runs'}

RESPONSE FORMAT:
<REPLY>1-2 sentences to the athlete confirming the change or explaining why no change.</REPLY>
If change needed, include:
<PLAN>
{"days":{"mon":{"label":"...","type":"easy|tempo|vo2|long|rest","segments":[{"dist":0,"unit":"mi","type":"easy|tempo|vo2|long","intensity":"...","reps":1}],"totalDist":0,"coachNote":""}}}
</PLAN>
If no change needed, output only <REPLY> and <NO_CHANGE/>.`;

  try {
    const resp = await fetch('/api/claude', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':ANTHROPIC_API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-client-side-api-keys':'true'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1200,
        system: systemPrompt,
        messages: [{ role:'user', content: `ATHLETE MESSAGE: "${text}"` }],
        athleteId: APP.athlete ? APP.athlete.id : null,
        contextDate: today.toISOString()
      })
    });
    const data = await resp.json();
    const raw = data.content?.[0]?.text || '';
    const replyMatch = raw.match(/<REPLY>([\s\S]*?)<\/REPLY>/);
    const planMatch = raw.match(/<PLAN>([\s\S]*?)<\/PLAN>/);
    const noChange = /<NO_CHANGE\s*\/>/.test(raw);
    const reply = replyMatch ? replyMatch[1].trim() : null;

    if (planMatch) {
      try {
        const updated = normalizePlanFromAI(JSON.parse(planMatch[1].trim()));
        if (updated && updated.days) {
          const mergedDays = { ...updated.days };
          Object.keys(APP_RX.days || {}).forEach(k => {
            if (APP_RX.days[k]?.completed) mergedDays[k] = APP_RX.days[k];
          });
          APP_RX.days = mergedDays;
          APP_RX.totalMiles = computeTotalMilesFromDays(mergedDays);
          APP_RX.updatedAt = new Date().toISOString();
          APP_RX.updatedBy = 'athlete_ai';
          renderRxSidebar(APP_RX);
          const changedDays = getChangedRxDays(prevDays, mergedDays).filter(k => !prevDays?.[k]?.completed);
          if (changedDays.length === 1) {
            showToast(`Plan updated ‚Äî ${formatDaySummary(changedDays[0], mergedDays)}`);
          } else if (changedDays.length > 1) {
            showToast(`Plan updated ‚Äî ${formatDaySummary(changedDays[0], mergedDays)} +${changedDays.length - 1} more`);
          }

          await fetch('/api/prescription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ athleteId: APP.athlete.id, action: 'athlete_update', prescription: APP_RX })
          });
        }
      } catch(e) {}
    }

    if (reply) return { reply, changed: !!planMatch };
    if (noChange) return { reply: null, changed: false };
  } catch(e) {}

  return null;
}

function isSmallTalkMessage(text) {
  const normalized = (text || '')
    .toLowerCase()
    .replace(/[^\w\s]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  if (!normalized) return false;
  if (normalized.length > 40) return false;
  return /^(hi|hey|hello|yo|sup|whats up|how are you|how r u|good morning|good afternoon|good evening|thanks|thank you|ok|okay|cool|nice)$/.test(normalized);
}

async function autoSaveWorkoutSummary(workout, firstAiResponse) {
  if (!APP.athlete) return;
  try {
    // Truncate to 200 chars for storage
    const summary = firstAiResponse.slice(0, 200).replace(/\n/g, ' ');
    await fetch('/api/athlete-memory', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        athleteId: APP.athlete.id,
        action: 'add_workout_summary',
        data: {
          workoutId: workout.id,
          workoutName: workout.name,
          summary
        }
      })
    });
  } catch(e) { console.warn('Memory save failed:', e); }
}

// ‚îÄ‚îÄ PRESCRIBED WORKOUTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let APP_RX = null;
let _rxPollInterval = null;

async function loadPrescribedWeek() {
  // Always show the toggle, even if no prescription exists
  const toggle = document.getElementById('rx-week-toggle');
  if (toggle) toggle.style.display = 'flex';
  const summary = document.getElementById('rx-week-summary');

  if (APP.demoMode) {
    // Show demo placeholder
    if (summary) summary.textContent = 'Demo mode ‚Äî no prescription';
    const panel = document.getElementById('rx-week-panel');
    if (panel) panel.innerHTML = '<div style="padding:12px 14px;font-family:IBM Plex Mono,monospace;font-size:10px;color:var(--muted);">Connect Strava and have coach push a plan to see your weekly prescription here.</div>';
    return;
  }

  if (!APP.athlete) return;
  if (summary) summary.textContent = 'Loading...';

  try {
    const res = await fetch(`/api/prescription?athleteId=${APP.athlete.id}&current=true&t=${Date.now()}`, { cache: 'no-store' });
    const rx = await res.json();
    if (rx && !rx.empty) {
      APP_RX = rx;
      renderRxSidebar(rx);
    } else {
      if (summary) summary.textContent = 'No prescription yet';
      const panel = document.getElementById('rx-week-panel');
      if (panel) panel.innerHTML = '<div style="padding:12px 14px;font-family:IBM Plex Mono,monospace;font-size:10px;color:var(--muted);">Your coach has not pushed next week plan yet. Check back soon.</div>';
    }
  } catch(e) {
    if (summary) summary.textContent = 'Unable to load';
  }
}

function toggleRxPanel() {
  const panel = document.getElementById('rx-week-panel');
  const arrow = document.getElementById('rx-toggle-arrow');
  const isOpen = panel.style.display !== 'none';
  panel.style.display = isOpen ? 'none' : 'block';
  arrow.textContent = isOpen ? '‚ñº' : '‚ñ≤';
}

function findMatchedWorkoutForRxDay(dayKey) {
  const day = APP_RX?.days?.[dayKey];
  if (!day) return null;
  if (day.activityId) {
    const exact = APP.activities.find(a => String(a.id) === String(day.activityId));
    if (exact) return exact;
  }
  const dayIdx = ['sun','mon','tue','wed','thu','fri','sat'].indexOf(dayKey);
  const matches = APP.activities.filter(a => new Date(a.start_date).getDay() === dayIdx);
  return matches.length ? matches[0] : null;
}

function renderRxSidebar(rx) {
  if (!rx || !rx.days) return;

  // Show toggle
  const toggle = document.getElementById('rx-week-toggle');
  toggle.style.display = 'flex';

  // Week summary
  const totalMi = rx.totalMiles || Object.values(rx.days)
    .filter(d => d.totalDist).reduce((s,d) => s + (d.totalDist||0), 0);
  const weekOf = rx.weekStart ? new Date(rx.weekStart + 'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
  document.getElementById('rx-week-summary').textContent =
    `${totalMi.toFixed ? totalMi.toFixed(0) : totalMi}mi ¬∑ week of ${weekOf}`;

  const panel = document.getElementById('rx-week-panel');
  panel.innerHTML = '';

  const dayOrder = ['mon','tue','wed','thu','fri','sat','sun'];
  const dayNames = {mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday',sun:'Sunday'};

  // Get today's day key
  const todayKey = ['sun','mon','tue','wed','thu','fri','sat'][new Date().getDay()];
  const weekStartMs = rx.weekStart ? new Date(rx.weekStart + 'T00:00:00').getTime() : null;

  dayOrder.forEach(dayKey => {
    const day = rx.days[dayKey];
    if (!day) return;

    const isRest = day.type === 'rest' || !day.label;
    if (isRest) return; // skip rest days in sidebar

    // Determine status
    const isToday = dayKey === todayKey;
    const isPast = weekStartMs ? (() => {
      const dayIdx = dayOrder.indexOf(dayKey);
      const dayMs = weekStartMs + dayIdx * 86400000;
      return dayMs < Date.now() - 86400000; // past if before yesterday
    })() : false;
    const isCompleted = day.completed;
    const isMissed = isPast && !isCompleted;

    let statusClass = 'upcoming';
    let statusLabel = isToday ? 'TODAY' : 'UPCOMING';
    if (isCompleted) { statusClass = 'completed'; statusLabel = `${day.letter || day.grade || '‚úì'}`; }
    else if (isMissed) { statusClass = 'missed'; statusLabel = 'MISSED'; }

    const row = document.createElement('div');
    row.className = `rx-day-row${isToday?' today':''}${isCompleted?' completed':isMissed?' missed':''}`;

    const segs = day.segments || [];
    const segSummary = segs.map(formatRxSegment).join(' ¬∑ ');
    const segDetailHtml = segs.length
      ? `<div style="margin-top:4px;display:flex;flex-direction:column;gap:2px;">${segs.map(s => `<div style="font-size:10px;color:var(--muted);">‚Ä¢ ${formatRxSegment(s)}</div>`).join('')}</div>`
      : '';

    const gradeHtml = isCompleted && day.grade
      ? `<span class="rx-grade ${day.letter || gradeToLetter(day.grade)}">${day.letter || gradeToLetter(day.grade)}</span>`
      : `<span class="rx-row-status ${statusClass}">${statusLabel}</span>`;

    const matchedWorkout = findMatchedWorkoutForRxDay(dayKey);
    const analyzeLabel = matchedWorkout && APP.analyzedWorkouts[matchedWorkout.id] ? 'RE-ANALYZE' : 'ANALYZE';
    const btnHtml = !isRest && rx.status === 'pushed' ? `
      ${isCompleted
        ? `<button class="rx-btn analyze" onclick="rxAnalyze('${dayKey}')">‚ö° ${analyzeLabel}</button>`
        : `<button class="rx-btn discuss" onclick="rxDiscuss('${dayKey}')">üí¨ Discuss</button>`
      }` : '';

    row.innerHTML = `
      <div class="rx-row-head">
        <div class="rx-row-day">${dayNames[dayKey]}</div>
        ${gradeHtml}
      </div>
      <div class="rx-row-label">${day.label || 'Workout'}</div>
      <div class="rx-row-detail">${day.totalDist ? day.totalDist + ' mi' : ''}${segSummary ? ' ¬∑ ' + segSummary : ''}</div>
      ${segDetailHtml}
      ${isCompleted ? `<div style="font-family:IBM Plex Mono,monospace;font-size:9px;color:var(--green);margin-top:4px;">‚úì COMPLETED${day.completedAt ? ' ¬∑ ' + new Date(day.completedAt).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : ''}</div>` : ''}
      ${day.coachNote ? `<div style="font-size:10px;color:var(--accent2);margin-top:3px;">üìù ${day.coachNote}</div>` : ''}
      ${btnHtml}
    `;
    panel.appendChild(row);
  });

  // Auto-open if there's a today entry
  if (rx.days[todayKey] && rx.days[todayKey].type !== 'rest') {
    document.getElementById('rx-week-panel').style.display = 'block';
    document.getElementById('rx-toggle-arrow').textContent = '‚ñ≤';
  }
}

function gradeToLetter(g) {
  return g >= 90 ? 'A' : g >= 80 ? 'B' : g >= 70 ? 'C' : g >= 60 ? 'D' : 'F';
}

function formatRxSegment(seg) {
  if (!seg) return '';
  const reps = seg.reps && seg.reps > 1 ? `${seg.reps}x ` : '';
  const dist = seg.dist ? `${seg.dist}${seg.unit || 'mi'}` : '';
  const type = seg.type ? String(seg.type).toUpperCase() : '';
  const intensity = seg.intensity ? ` @ ${seg.intensity}` : '';
  return `${reps}${dist} ${type}${intensity}`.trim();
}

function startRxPolling() {
  if (_rxPollInterval || APP.demoMode) return;
  _rxPollInterval = setInterval(() => {
    if (APP.athlete && !document.hidden) loadPrescribedWeek();
  }, 3000);
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && APP.athlete) loadPrescribedWeek();
  });
}

async function rxAnalyze(dayKey) {
  // Switch to coach tab and trigger analyze for matching workout
  showPage('coach', document.querySelector('[onclick*="coach"]'));
  const match = findMatchedWorkoutForRxDay(dayKey);
  if (match) {
    const el = document.querySelector(`.history-item[data-id="${match.id}"]`);
    if (el) await selectWorkout(match, el);
    else APP.currentWorkout = match;
    await analyzeWorkout();
    return;
  }
  await analyzeWorkout();
}

function rxDiscuss(dayKey) {
  // Switch to coach tab with discuss context
  showPage('coach', document.querySelector('[onclick*="coach"]'));
  const day = APP_RX?.days?.[dayKey];
  if (!day) return;

  // Pre-fill chat with discuss context
  setTimeout(() => {
    const input = document.getElementById('chat-input');
    if (input) {
      input.value = `I want to discuss ${day.label || 'my prescribed workout'} for ${dayKey}`;
      input.focus();
    }
  }, 300);
}

// Auto-grade when a workout is selected that matches a prescription
function checkRxGrade(activity) {
  if (!APP_RX || !activity || APP.demoMode) return null;
  const dayIdx = new Date(activity.start_date).getDay();
  const dayKey = ['sun','mon','tue','wed','thu','fri','sat'][dayIdx];
  const prescribed = APP_RX.days?.[dayKey];
  if (!prescribed || prescribed.type === 'rest') return null;

  const KB = typeof RUNIQ_KB !== 'undefined' ? RUNIQ_KB : null;
  if (!KB) return null;

  const gradeResult = KB.gradeWorkout(prescribed, activity);
  if (!gradeResult) return null;

  // Save grade to KV
  fetch('/api/prescription', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      athleteId: APP.athlete.id,
      action: 'update_completion',
      day: dayKey,
      activityId: activity.id,
      grade: gradeResult.grade,
      gradeBreakdown: gradeResult.breakdown,
      prescription: APP_RX
    })
  }).catch(() => {});

  // Update local cache
  if (APP_RX.days[dayKey]) {
    APP_RX.days[dayKey].completed = true;
    APP_RX.days[dayKey].grade = gradeResult.grade;
    APP_RX.days[dayKey].letter = gradeResult.letter;
    APP_RX.days[dayKey].activityId = activity.id;
    renderRxSidebar(APP_RX);
  }

  return gradeResult;
}

function pingCoach() {
  const btn = document.getElementById('ping-btn');
  btn.className = 'ping-btn pinged';
  btn.textContent = '‚úì Pinged';
  addMsg('human-coach', `Coach Mike has been notified and will review this workout. Expected response within 24 hours.`);
  // In production this would trigger a notification to the coach portal
  persistChat();
}

function getChatPayload() {
  return {
    html: document.getElementById('chat-messages').innerHTML,
    history: APP.chatHistory,
    ts: Date.now()
  };
}

function saveChatHistory() {
  const key = getThreadStorageKey();
  if (!key) return;
  const data = getChatPayload();
  try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {}
}

function renderChatFromHistory(history) {
  const container = document.getElementById('chat-messages');
  container.innerHTML = '';
  const normalizedHistory = [];
  (history || []).forEach(m => {
    const sender = m.sender || (m.role === 'assistant' ? 'ai' : m.role === 'coach' ? 'human-coach' : 'athlete');
    const role = sender === 'ai' ? 'ai' : sender === 'coach' || sender === 'human-coach' ? 'human-coach' : 'athlete';
    addMsg(role, m.content || '');
    if (m.role === 'assistant' || m.role === 'user') normalizedHistory.push({ role: m.role, content: m.content || '' });
  });
  APP.chatHistory = normalizedHistory;
  container.scrollTop = 999999;
}

function rebuildAnalyzedWorkouts(history) {
  const list = Array.isArray(history)
    ? history
    : Array.isArray(history?.messages)
      ? history.messages
      : Array.isArray(history?.history)
        ? history.history
        : [];
  APP.analyzedWorkouts = {};
  list.forEach(msg => {
    if (!msg || msg.role !== 'user' || !msg.workoutId) return;
    if ((msg.content || '').trim().toLowerCase() === 'analyze my workout.') {
      APP.analyzedWorkouts[msg.workoutId] = true;
    }
  });
}

async function loadChatHistory(workoutId = null, selectSeq = null) {
  const container = document.getElementById('chat-messages');
  const isStaleSelection = () => {
    if (!APP.currentWorkout) return true;
    if (workoutId && APP.currentWorkout.id !== workoutId) return true;
    if (selectSeq === null) return false;
    return selectSeq !== APP._workoutSelectSeq;
  };
  const applyHistoryPayload = (raw) => {
    if (isStaleSelection()) return false;
    if (!raw || typeof raw !== 'object') return false;
    if (Array.isArray(raw)) {
      renderChatFromHistory(raw);
      return true;
    }
    if (Array.isArray(raw.history)) {
      if (raw.html) {
        container.innerHTML = raw.html;
        APP.chatHistory = raw.history || [];
        container.scrollTop = 999999;
      } else {
        renderChatFromHistory(raw.history);
      }
      return true;
    }
    if (raw.html) {
      container.innerHTML = raw.html || '';
      APP.chatHistory = raw.history || [];
      container.scrollTop = 999999;
      return true;
    }
    return false;
  };
  // Try KV first (unified athlete timeline)
  if (APP.athlete && APP.athlete.id) {
    try {
      const url = workoutId
        ? `/api/chat-history?athleteId=${APP.athlete.id}&workoutId=${workoutId}`
        : `/api/chat-history?athleteId=${APP.athlete.id}`;
      const res = await fetch(url);
      if (res.ok) {
        const data = await res.json();
        if (isStaleSelection()) return false;
        const payload = data && (data.messages !== undefined ? data.messages : data);
        if (applyHistoryPayload(payload)) {
          rebuildAnalyzedWorkouts(payload);
          return true;
        }
      }
    } catch(e) {}
  }
  // Fall back to localStorage (unified key first, legacy per-workout key as backup)
  const key = getThreadStorageKey();
  const legacyKey = workoutId ? `runiq_chat_${workoutId}` : null;
  try {
    const data = JSON.parse((key ? localStorage.getItem(key) : null) || (legacyKey ? localStorage.getItem(legacyKey) : null));
    if (applyHistoryPayload(data)) {
      rebuildAnalyzedWorkouts(data);
      return true;
    }
  } catch(e) {}
  return false;
}

function saveChatToStorage() {
  const key = getThreadStorageKey();
  if (!key) return;
  const payload = getChatPayload();
  localStorage.setItem(key, JSON.stringify(payload));
}

async function persistChat() {
  const payload = getChatPayload();
  const key = getThreadStorageKey();
  try {
    if (key) localStorage.setItem(key, JSON.stringify(payload));
  } catch(e) {}
}

function addMsg(role, text) {
  const container = document.getElementById('chat-messages');
  const el = document.createElement('div');
  const isAI = role === 'ai', isCoach = role === 'human-coach';
  el.className = `msg ${isAI ? 'ai' : isCoach ? 'human-coach' : 'athlete'}`;
  const avCls = isAI ? 'ai-av' : isCoach ? 'human-av' : 'athlete-av';
  const avIcon = isAI ? 'ü§ñ' : isCoach ? 'üë®‚Äçüíº' : 'üèÉ';
  const senderCls = isAI ? 'ai-sender' : isCoach ? 'human-sender' : 'athlete-sender';
  const senderLabel = isAI ? 'AI Coach' : isCoach ? 'Coach Mike' : 'You';
  el.innerHTML = `
    <div class="msg-avatar ${avCls}">${avIcon}</div>
    <div>
      <div class="msg-sender ${senderCls}">${senderLabel}</div>
      <div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div>
    </div>`;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function showTyping() {
  document.getElementById('typing-ind').classList.add('visible');
  document.getElementById('chat-messages').scrollTop = 999999;
}
function hideTyping() { document.getElementById('typing-ind').classList.remove('visible'); }
function handleChatKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }
function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,110)+'px'; }
function setSuggestedReplies(replies) {
  const c = document.getElementById('suggested-replies');
  c.innerHTML = '';
  replies.forEach(r => {
    const chip = document.createElement('div');
    chip.className = 'reply-chip';
    chip.textContent = r;
    chip.onclick = () => { document.getElementById('chat-input').value = r; sendMessage(); };
    c.appendChild(chip);
  });
}

function renderWeeklySummary() {
  const weekAgo = Date.now() - 7*86400000;
  const weekRuns = APP.activities.filter(a => new Date(a.start_date) >= weekAgo);
  const totalMi = weekRuns.reduce((s,a) => s+actToMi(a), 0);
  const qualityRuns = weekRuns.filter(a => a._effort === 'tempo' || a._effort === 'vo2' || (a.average_heartrate && a.average_heartrate > 155));
  const panel = document.getElementById('weekly-summary-panel');
  panel.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:0;border:1px solid var(--border);border-radius:var(--r);">
      ${[
        ['Volume', `${totalMi.toFixed(1)} mi`],
        ['Runs', weekRuns.length],
        ['Quality', `${qualityRuns.length} sessions`],
        ['Avg HR', weekRuns.filter(a=>a.average_heartrate).length ? Math.round(weekRuns.filter(a=>a.average_heartrate).reduce((s,a)=>s+a.average_heartrate,0)/weekRuns.filter(a=>a.average_heartrate).length)+' bpm' : '‚Äî'],
      ].map(([l,v]) => `<div style="display:flex;justify-content:space-between;padding:7px 10px;border-bottom:1px solid var(--border);"><span style="font-size:11px;color:var(--muted);">${l}</span><span style="font-family:IBM Plex Mono,monospace;font-size:11px;">${v}</span></div>`).join('')}
    </div>`;
}

// ‚îÄ‚îÄ ACTIVITY EXCLUSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleActivityList() {
  const body = document.getElementById('activity-list-body');
  const toggle = document.getElementById('act-list-toggle');
  const open = body.classList.toggle('open');
  toggle.textContent = open ? '‚ñ≤ HIDE' : '‚ñº SHOW';
}

function renderActivityList() {
  const container = document.getElementById('activity-rows');
  if (!container) return;
  const weeks = parseInt(document.getElementById('est-window').value);
  const cutoff = Date.now() - weeks * 7 * 86400000;
  const shown = [...APP.activities]
    .filter(a => new Date(a.start_date).getTime() > cutoff)
    .sort((a,b) => new Date(b.start_date) - new Date(a.start_date));

  container.innerHTML = '';
  for (const act of shown) {
    const excl = APP.excluded.has(act.id);
    const mi = actToMi(act).toFixed(1);
    const pace = fmtPace(actPaceMi(act));
    const date = new Date(act.start_date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const row = document.createElement('div');
    row.className = `activity-row${excl?' excluded':''}`;
    row.innerHTML = `
      <div class="act-name" title="${act.name}"><a href="https://www.strava.com/activities/${act.id}" target="_blank" style="color:inherit;text-decoration:none;">${act.name} <span style="color:var(--accent);font-size:9px;">‚Üó</span></a></div>
      <div class="act-date">${date}</div>
      <div class="act-dist">${mi} mi</div>
      <div class="act-pace">${pace}/mi</div>
      <button class="act-remove${excl?' restore':''}" onclick="toggleExclude(${act.id})" title="${excl?'Restore':'Exclude'}">${excl?'‚Ü©':'‚úï'}</button>`;
    container.appendChild(row);
  }
  const excCount = APP.excluded.size;
  const countEl = document.getElementById('excluded-count');
  if (excCount > 0) {
    countEl.textContent = `${excCount} activit${excCount===1?'y':'ies'} excluded from calculations`;
    countEl.className = 'excluded-count visible';
  } else {
    countEl.className = 'excluded-count';
  }
}

function toggleExclude(actId) {
  if (APP.excluded.has(actId)) APP.excluded.delete(actId);
  else APP.excluded.add(actId);
  renderActivityList();
  updateEstimates();
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtTime(s) {
  const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=Math.round(s%60);
  return h>0?`${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`:`${m}:${String(sec).padStart(2,'0')}`;
}
function fmtPace(spm) {
  if(!spm||!isFinite(spm)) return '‚Äî:‚Äî‚Äî';
  const m=Math.floor(spm/60),s=Math.round(spm%60);
  return `${m}:${String(s).padStart(2,'0')}`;
}
function fmtPaceMiDist(s, distMi) { return fmtPace(s/distMi)+' /mi'; }
</script>
</body>
</html>
